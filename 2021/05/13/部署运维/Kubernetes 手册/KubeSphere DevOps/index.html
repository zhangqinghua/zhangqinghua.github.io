<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="限制 DevOps 运行在指定节点参考：为依赖项缓存设置 CI 节点  经过测试不能指定在 master 节点上。  构建 Vue 应用流水线大体流程：  将 Vue 项目编译成为 dist 文件； 将 dist 打包成为 Docker Nginx 镜像； 上传到阿里云容器镜像仓库； 部署到集群中； 配置网关路由公网访问；  jenkins 配置12345678910111213141516171">
<meta property="og:type" content="article">
<meta property="og:title" content="KubeSphere DevOps">
<meta property="og:url" content="http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="限制 DevOps 运行在指定节点参考：为依赖项缓存设置 CI 节点  经过测试不能指定在 master 节点上。  构建 Vue 应用流水线大体流程：  将 Vue 项目编译成为 dist 文件； 将 dist 打包成为 Docker Nginx 镜像； 上传到阿里云容器镜像仓库； 部署到集群中； 配置网关路由公网访问；  jenkins 配置12345678910111213141516171">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-07-13T12:31:14.888Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KubeSphere DevOps">
<meta name="twitter:description" content="限制 DevOps 运行在指定节点参考：为依赖项缓存设置 CI 节点  经过测试不能指定在 master 节点上。  构建 Vue 应用流水线大体流程：  将 Vue 项目编译成为 dist 文件； 将 dist 打包成为 Docker Nginx 镜像； 上传到阿里云容器镜像仓库； 部署到集群中； 配置网关路由公网访问；  jenkins 配置12345678910111213141516171">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>KubeSphere DevOps</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/05/13/部署运维/Kubernetes 手册/KubeSphere 部署应用/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/05/12/前端开发/小程序开发/小程序开发/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&text=KubeSphere DevOps"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&is_video=false&description=KubeSphere DevOps"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KubeSphere DevOps&body=Check out this article: http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&name=KubeSphere DevOps&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#限制-DevOps-运行在指定节点"><span class="toc-number">1.</span> <span class="toc-text">限制 DevOps 运行在指定节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建-Vue-应用流水线"><span class="toc-number">2.</span> <span class="toc-text">构建 Vue 应用流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jenkins-配置"><span class="toc-number">2.0.1.</span> <span class="toc-text">jenkins 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile"><span class="toc-number">2.0.2.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kube-Pod-资源清单"><span class="toc-number">2.0.3.</span> <span class="toc-text">Kube Pod 资源清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建-SpringCloud-应用流水线"><span class="toc-number">3.</span> <span class="toc-text">构建 SpringCloud 应用流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jenkins-配置-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">jenkins 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kube-Pod-资源清单-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">Kube Pod 资源清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">4.</span> <span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#给-SpringBoot-应用动态传参"><span class="toc-number">4.0.1.</span> <span class="toc-text">给 SpringBoot 应用动态传参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义运行-pod-资源文件"><span class="toc-number">4.0.2.</span> <span class="toc-text">自定义运行 pod 资源文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkinsfile-使用-choice-参数时，修改没有生效"><span class="toc-number">4.0.3.</span> <span class="toc-text">Jenkinsfile 使用 choice 参数时，修改没有生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#流水线更新应用，deployment安装失败"><span class="toc-number">4.0.4.</span> <span class="toc-text">流水线更新应用，deployment安装失败</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        KubeSphere DevOps
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Hexo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-05-13T07:00:06.000Z" itemprop="datePublished">2021-05-13</time>
        
        (Updated: <time datetime="2021-07-13T12:31:14.888Z" itemprop="dateModified">2021-07-13</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/部署运维/">部署运维</a> › <a class="category-link" href="/categories/部署运维/Kubernetes-手册/">Kubernetes 手册</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="限制-DevOps-运行在指定节点"><a href="#限制-DevOps-运行在指定节点" class="headerlink" title="限制 DevOps 运行在指定节点"></a>限制 DevOps 运行在指定节点</h2><p>参考：<a href="https://kubesphere.com.cn/docs/devops-user-guide/how-to-use/set-ci-node/">为依赖项缓存设置 CI 节点</a></p>
<blockquote>
<p>经过测试不能指定在 master 节点上。</p>
</blockquote>
<h2 id="构建-Vue-应用流水线"><a href="#构建-Vue-应用流水线" class="headerlink" title="构建 Vue 应用流水线"></a>构建 Vue 应用流水线</h2><p>大体流程：</p>
<ol>
<li>将 Vue 项目编译成为 dist 文件；</li>
<li>将 dist 打包成为 Docker Nginx 镜像；</li>
<li>上传到阿里云容器镜像仓库；</li>
<li>部署到集群中；</li>
<li>配置网关路由公网访问；</li>
</ol>
<h4 id="jenkins-配置"><a href="#jenkins-配置" class="headerlink" title="jenkins 配置"></a>jenkins 配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line"></span><br><span class="line">  environment &#123;</span><br><span class="line">    // 项目名称</span><br><span class="line">    APP_NAME = &apos;easybyte-front-sys&apos;</span><br><span class="line">    // 项目版本</span><br><span class="line">    APP_VERSION = sh(script: &quot;echo `date &apos;+%Y%m%d%H%M%S&apos;`&quot;, returnStdout: true).trim()</span><br><span class="line">    // 项目空间</span><br><span class="line">    APP_NAME_SPACE = &apos;easybyte-dev&apos;</span><br><span class="line">    </span><br><span class="line">    // 代码仓库地址</span><br><span class="line">    GIT_URL = &apos;https://code.aliyun.com/easybyte-web/easybyte-sys.git&apos;</span><br><span class="line">    // 代码版本</span><br><span class="line">    GIT_BRANCH = &apos;master&apos;</span><br><span class="line">    // 代码凭证</span><br><span class="line">    GIT_CREDENTIAL = &apos;aliyuncode-credential&apos;</span><br><span class="line"></span><br><span class="line">    // 镜像仓库地址</span><br><span class="line">    DOCKER_REGISTRY = &apos;registry.cn-shenzhen.aliyuncs.com&apos;</span><br><span class="line">    // 镜像命名空间</span><br><span class="line">    DOCKER_NAMESPACE = &apos;easybyte&apos;</span><br><span class="line">    // 镜像仓库凭证</span><br><span class="line">    DOCKER_CREDENTIAL = &apos;aliyunrepository-credential&apos;</span><br><span class="line">    </span><br><span class="line">    // 资源清单所在位置</span><br><span class="line">    DEPLOY_CONFIGS = &quot;Deploy.yml&quot;</span><br><span class="line">    // 集群的Id</span><br><span class="line">    DEPLOY_KUBECONFIID = &apos;kubeconfig-credential&apos;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label &apos;nodejs&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&apos;基本信息&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &apos;echo -e &quot;\n APP_NAME: $APP_NAME \n NAME_SPACE: $NAME_SPACE \n APP_VERSION: $APP_VERSION \n GIT_URL: $GIT_URL \n GIT_BRANCH: $GIT_BRANCH \n GIT_CREDENTIAL: $GIT_CREDENTIAL \n DOCKER_REGISTRY: $DOCKER_REGISTRY \n DOCKER_NAMESPACE: $DOCKER_NAMESPACE \n DOCKER_CREDENTIAL: $DOCKER_CREDENTIAL \n DEPLOY_CONFIGS: $DEPLOY_CONFIGS \n DEPLOY_KUBECONFIID: $DEPLOY_KUBECONFIID&quot;&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stage(&apos;拉取代码&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;nodejs&apos;) &#123;</span><br><span class="line">          git(url: &quot;$GIT_URL&quot;, credentialsId: &quot;$GIT_CREDENTIAL&quot;, branch: &quot;$GIT_BRANCH&quot;, changelog: true, poll: false)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;安装依赖&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;nodejs&apos;) &#123;</span><br><span class="line">          sh &apos;npm install -g cnpm --registry=https://registry.npm.taobao.org&apos;</span><br><span class="line">          sh &apos;cnpm i --no-package-lock&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;编译项目&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;nodejs&apos;) &#123;</span><br><span class="line">          sh &apos;yarn build&apos;</span><br><span class="line">          sh &apos;ls -a&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;构建镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;nodejs&apos;) &#123;</span><br><span class="line">          sh &apos;docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$APP_VERSION .&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;上传镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;nodejs&apos;) &#123;</span><br><span class="line">          withCredentials([usernamePassword(passwordVariable : &apos;DOCKER_PASSWORD&apos; ,usernameVariable : &apos;DOCKER_USERNAME&apos; ,credentialsId : &quot;$DOCKER_CREDENTIAL&quot; ,)]) &#123;</span><br><span class="line">            sh &apos;echo &quot;$DOCKER_PASSWORD&quot; | docker login $DOCKER_REGISTRY -u &quot;$DOCKER_USERNAME&quot; --password-stdin&apos;</span><br><span class="line">            sh &apos;docker push $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$APP_VERSION&apos;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;部署应用&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        // enableConfigSubstitution 是否开启变量替换（即替换Deploy.yml里面的配置）</span><br><span class="line">        // kubeconfigId             集群的Id</span><br><span class="line">        // configs                  资源文件所在位置</span><br><span class="line">        kubernetesDeploy(enableConfigSubstitution: true, deleteResource: false, kubeconfigId: &quot;$DEPLOY_KUBECONFIID&quot;, configs: &quot;$DEPLOY_CONFIGS&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Alpine Linux是：一个基于musl libc和busybox、面向安全的轻量级Linux发行版。</span></span><br><span class="line"><span class="comment"># ngixn 打包大小为 133 MB，nginx:stable-alpine 只有 20 MB。</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:stable-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将dist文件中的内容复制到 /usr/share/nginx/html/merchant 这个目录下面</span></span><br><span class="line"><span class="comment"># 前端访问时使用 http://dev.easybyte-hk.com/merchant/ &gt; http://localhost:80/merchant</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> dist/  /usr/share/nginx/html/merchant</span></span><br></pre></td></tr></table></figure>
<h4 id="Kube-Pod-资源清单"><a href="#Kube-Pod-资源清单" class="headerlink" title="Kube Pod 资源清单"></a>Kube Pod 资源清单</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务配置</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">$NAME_SPACE</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="comment"># 容器内部端口，服务端口</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># pod 端口，容器外部端口，可以重复（每个pod都有一个独立的ip）</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">$NAME_SPACE</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$VERSION</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">              protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">          terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">          terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="comment"># 拉取镜像策略，当本地不存在时拉取。</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="comment"># 容器自动自动（Always：当容器失效时，由kubelet自动重启该容器。OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器。Never：不论容器运行状态如何，kubelet都不会重启该容器。）</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="comment"># 优雅停机毫秒</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="comment"># 发布策略（滚动更新）</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">100</span><span class="string">%</span></span><br></pre></td></tr></table></figure>
<h2 id="构建-SpringCloud-应用流水线"><a href="#构建-SpringCloud-应用流水线" class="headerlink" title="构建 SpringCloud 应用流水线"></a>构建 SpringCloud 应用流水线</h2><h4 id="jenkins-配置-1"><a href="#jenkins-配置-1" class="headerlink" title="jenkins 配置"></a>jenkins 配置</h4><p>单模块部署：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line"></span><br><span class="line">  parameters &#123;</span><br><span class="line">    choice(name: &apos;APP_NAME&apos;,</span><br><span class="line">           choices: [&apos;easybyte-log&apos;,</span><br><span class="line">                     &apos;easybyte-pay&apos;,</span><br><span class="line">                     &apos;easybyte-auth&apos;,</span><br><span class="line">                     &apos;easybyte-base&apos;,</span><br><span class="line">                     &apos;easybyte-flow&apos;,</span><br><span class="line">                     &apos;easybyte-cart&apos;,</span><br><span class="line">                     &apos;easybyte-store&apos;,</span><br><span class="line">                     &apos;easybyte-order&apos;,</span><br><span class="line">                     &apos;easybyte-media&apos;,</span><br><span class="line">                     &apos;easybyte-stats&apos;,</span><br><span class="line">                     &apos;easybyte-member&apos;,</span><br><span class="line">                     &apos;easybyte-market&apos;,</span><br><span class="line">                     &apos;easybyte-swagger&apos;,</span><br><span class="line">                     &apos;easybyte-product&apos;,</span><br><span class="line">                     &apos;easybyte-gateway&apos;,</span><br><span class="line">                     &apos;easybyte-merchant&apos;,</span><br><span class="line">                     &apos;easybyte-consumer&apos;,</span><br><span class="line">                     &apos;easybyte-template&apos;,</span><br><span class="line">                     &apos;easybyte-scheduled&apos;],</span><br><span class="line">           description: &apos;选择部署的模块&apos;);</span><br><span class="line">                     </span><br><span class="line">    choice(name: &apos;GIT_BRANCH&apos;,</span><br><span class="line">           choices: [&apos;develop&apos;, &apos;release&apos;,&apos;master&apos;],</span><br><span class="line">           description: &apos;选择部署的分支&apos;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  environment &#123;</span><br><span class="line">    // 项目版本</span><br><span class="line">    APP_VERSION = sh(script: &quot;echo `date &apos;+%Y%m%d%H%M%S&apos;`&quot;, returnStdout: true).trim()</span><br><span class="line">    // 项目空间</span><br><span class="line">    APP_NAME_SPACE = &apos;easybyte-dev&apos;</span><br><span class="line">    // Nacos 配置分组</span><br><span class="line">    NACOS_GROUP = &apos;153cda3e-322c-4ff1-8aa0-d1240784dbd2&apos;</span><br><span class="line"></span><br><span class="line">    // 代码仓库地址</span><br><span class="line">    GIT_URL = &apos;https://code.aliyun.com/easybyte-java/easybyte.git&apos;</span><br><span class="line">    // 代码版本</span><br><span class="line">    // GIT_BRANCH = &apos;master&apos;</span><br><span class="line">    // 代码凭证</span><br><span class="line">    GIT_CREDENTIAL = &apos;aliyuncode-credential&apos;</span><br><span class="line"></span><br><span class="line">    // 镜像仓库地址</span><br><span class="line">    DOCKER_REGISTRY = &apos;registry.cn-shenzhen.aliyuncs.com&apos;</span><br><span class="line">    // 镜像命名空间</span><br><span class="line">    DOCKER_NAMESPACE = &apos;easybyte&apos;</span><br><span class="line">    // 镜像仓库凭证</span><br><span class="line">    DOCKER_CREDENTIAL = &apos;aliyunrepository-credential&apos;</span><br><span class="line"></span><br><span class="line">    // 资源清单所在位置</span><br><span class="line">    DEPLOY_CONFIGS = &quot;Deploy.yml&quot;</span><br><span class="line">    // 集群的Id</span><br><span class="line">    DEPLOY_KUBECONFIID = &apos;kubeconfig-credential&apos;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label &apos;maven&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&apos;基本信息&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &apos;echo -e &quot;\n APP_NAME: $APP_NAME \n APP_NAME_SPACE: $APP_NAME_SPACE \n APP_VERSION: $APP_VERSION \n NACOS_GROUP: $NACOS_GROUP \n GIT_URL: $GIT_URL \n GIT_BRANCH: $GIT_BRANCH \n GIT_CREDENTIAL: $GIT_CREDENTIAL \n DOCKER_REGISTRY: $DOCKER_REGISTRY \n DOCKER_NAMESPACE: $DOCKER_NAMESPACE \n DOCKER_CREDENTIAL: $DOCKER_CREDENTIAL \n DEPLOY_CONFIGS: $DEPLOY_CONFIGS \n DEPLOY_KUBECONFIID: $DEPLOY_KUBECONFIID&quot;&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;拉取代码&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          git(url: &quot;$GIT_URL&quot;, credentialsId: &quot;$GIT_CREDENTIAL&quot;, branch: &quot;$GIT_BRANCH&quot;, changelog: true, poll: false)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;编译项目&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          sh &apos;mvn clean package -DskipTests -pl $APP_NAME -am&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;构建镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          sh &quot;docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$APP_VERSION --build-arg APP_NAME=$APP_NAME .&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;上传镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          withCredentials([usernamePassword(passwordVariable : &apos;DOCKER_PASSWORD&apos; ,usernameVariable : &apos;DOCKER_USERNAME&apos; ,credentialsId : &quot;$DOCKER_CREDENTIAL&quot; ,)]) &#123;</span><br><span class="line">            sh &apos;echo &quot;$DOCKER_PASSWORD&quot; | docker login $DOCKER_REGISTRY -u &quot;$DOCKER_USERNAME&quot; --password-stdin&apos;</span><br><span class="line">            sh &apos;docker push $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$APP_VERSION&apos;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;部署应用&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        // enableConfigSubstitution 是否开启变量替换（即替换Deploy.yml里面的配置）</span><br><span class="line">        // kubeconfigId             集群的Id</span><br><span class="line">        // configs                  资源文件所在位置</span><br><span class="line">        kubernetesDeploy(enableConfigSubstitution: true, deleteResource: false, kubeconfigId: &quot;$DEPLOY_KUBECONFIID&quot;, configs: &quot;$DEPLOY_CONFIGS&quot;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>全部模块一起部署：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">def MODULES = [&apos;easybyte-log&apos;,</span><br><span class="line">               &apos;easybyte-pay&apos;,</span><br><span class="line">               &apos;easybyte-auth&apos;,</span><br><span class="line">               &apos;easybyte-base&apos;,</span><br><span class="line">               &apos;easybyte-flow&apos;,</span><br><span class="line">               &apos;easybyte-cart&apos;,</span><br><span class="line">               &apos;easybyte-store&apos;,</span><br><span class="line">               &apos;easybyte-order&apos;,</span><br><span class="line">               &apos;easybyte-media&apos;,</span><br><span class="line">               &apos;easybyte-stats&apos;,</span><br><span class="line">               &apos;easybyte-member&apos;,</span><br><span class="line">               &apos;easybyte-market&apos;,</span><br><span class="line">               &apos;easybyte-swagger&apos;,</span><br><span class="line">               &apos;easybyte-product&apos;,</span><br><span class="line">               &apos;easybyte-gateway&apos;,</span><br><span class="line">               &apos;easybyte-merchant&apos;,</span><br><span class="line">               &apos;easybyte-consumer&apos;,</span><br><span class="line">               &apos;easybyte-template&apos;,</span><br><span class="line">               &apos;easybyte-scheduled&apos;];</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">  parameters &#123;</span><br><span class="line">    choice(name: &apos;GIT_BRANCH&apos;,</span><br><span class="line">           choices: [&apos;develop&apos;, &apos;release&apos;, &apos;master&apos;],</span><br><span class="line">           description: &apos;选择部署的分支&apos;)</span><br><span class="line">  &#125;</span><br><span class="line">  environment &#123;</span><br><span class="line">    // 项目版本</span><br><span class="line">    APP_VERSION = sh(script: &quot;echo `date &apos;+%Y%m%d%H%M%S&apos;`&quot;, returnStdout: true).trim()</span><br><span class="line">    // 项目空间</span><br><span class="line">    APP_NAME_SPACE = &apos;easybyte-dev&apos;</span><br><span class="line">    // Nacos 配置分组</span><br><span class="line">    NACOS_GROUP = &apos;153cda3e-322c-4ff1-8aa0-d1240784dbd2&apos;</span><br><span class="line"></span><br><span class="line">    // 代码仓库地址</span><br><span class="line">    GIT_URL = &apos;https://code.aliyun.com/easybyte-java/easybyte.git&apos;</span><br><span class="line">    // 代码版本</span><br><span class="line">    // GIT_BRANCH = &apos;master&apos;</span><br><span class="line">    // 代码凭证</span><br><span class="line">    GIT_CREDENTIAL = &apos;aliyuncode-credential&apos;</span><br><span class="line"></span><br><span class="line">    // 镜像仓库地址</span><br><span class="line">    DOCKER_REGISTRY = &apos;registry.cn-shenzhen.aliyuncs.com&apos;</span><br><span class="line">    // 镜像命名空间</span><br><span class="line">    DOCKER_NAMESPACE = &apos;easybyte&apos;</span><br><span class="line">    // 镜像仓库凭证</span><br><span class="line">    DOCKER_CREDENTIAL = &apos;aliyunrepository-credential&apos;</span><br><span class="line"></span><br><span class="line">    // 资源清单所在位置</span><br><span class="line">    DEPLOY_CONFIGS = &quot;Deploy.yml&quot;</span><br><span class="line">    // 集群的Id</span><br><span class="line">    DEPLOY_KUBECONFIID = &apos;kubeconfig-credential&apos;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label &apos;maven&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(&apos;基本信息&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &apos;echo -e &quot;\n APP_NAME: $APP_NAME \n APP_NAME_SPACE: $APP_NAME_SPACE \n APP_VERSION: $APP_VERSION \n NACOS_GROUP: $NACOS_GROUP \n GIT_URL: $GIT_URL \n GIT_BRANCH: $GIT_BRANCH \n GIT_CREDENTIAL: $GIT_CREDENTIAL \n DOCKER_REGISTRY: $DOCKER_REGISTRY \n DOCKER_NAMESPACE: $DOCKER_NAMESPACE \n DOCKER_CREDENTIAL: $DOCKER_CREDENTIAL \n DEPLOY_CONFIGS: $DEPLOY_CONFIGS \n DEPLOY_KUBECONFIID: $DEPLOY_KUBECONFIID&quot;&apos;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;拉取代码&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          git(url: &quot;$GIT_URL&quot;, credentialsId: &quot;$GIT_CREDENTIAL&quot;, branch: &quot;$GIT_BRANCH&quot;, changelog: true, poll: false)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;编译项目&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          sh &apos;mvn clean package -DskipTests&apos;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;构建镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          script &#123;</span><br><span class="line">            for (String MODULE : MODULES) &#123;</span><br><span class="line">              sh &quot;docker build -f Dockerfile -t $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$MODULE:$APP_VERSION --build-arg APP_NAME=$MODULE .&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;上传镜像&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          withCredentials([usernamePassword(passwordVariable : &apos;DOCKER_PASSWORD&apos; ,usernameVariable : &apos;DOCKER_USERNAME&apos; ,credentialsId : &quot;$DOCKER_CREDENTIAL&quot; ,)]) &#123;</span><br><span class="line">            sh &apos;echo &quot;$DOCKER_PASSWORD&quot; | docker login $DOCKER_REGISTRY -u &quot;$DOCKER_USERNAME&quot; --password-stdin&apos;</span><br><span class="line">              script &#123;</span><br><span class="line">                for (String MODULE : MODULES) &#123;</span><br><span class="line">                  sh &quot;docker push $DOCKER_REGISTRY/$DOCKER_NAMESPACE/$MODULE:$APP_VERSION&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(&apos;部署应用&apos;) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(&apos;maven&apos;) &#123;</span><br><span class="line">          script &#123;</span><br><span class="line">            for (String MODULE : MODULES) &#123;</span><br><span class="line">              // kubernetesDeploy 好像只能识别全局变量 env</span><br><span class="line">              env.APP_NAME = MODULE</span><br><span class="line">              // enableConfigSubstitution 是否开启变量替换（即替换Deploy.yml里面的配置）</span><br><span class="line">              // kubeconfigId             集群的Id</span><br><span class="line">              // configs                  资源文件所在位置</span><br><span class="line">              kubernetesDeploy(enableConfigSubstitution: true, deleteResource: false, kubeconfigId: &quot;$DEPLOY_KUBECONFIID&quot;, configs: &quot;$DEPLOY_CONFIGS&quot;)</span><br><span class="line">              sleep 20</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 加载Easybyte通用库和运行环境（lib有70MB Java应用环境100MB）</span></span><br><span class="line"><span class="keyword">FROM</span>        zhangqinghua/easybyte-lib:<span class="number">0.0</span>.<span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.接收从外边传来的参数 easybyte-auth</span></span><br><span class="line"><span class="keyword">ARG</span>         APP_NAME</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 把应用包复制进容器（排除了lib的应用体积大概在1MB左右）复制本地的renren-fast.jar文件到容器/目录并改名app.jar easybyte-auth/target/easybyte-auth.jar -&gt; /app.jar</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash">         <span class="variable">$&#123;APP_NAME&#125;</span>/target/<span class="variable">$&#123;APP_NAME&#125;</span>.jar /app.jar</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># 4. 对外开放的端口，8070给Txlcn用</span></span></span><br><span class="line"><span class="bash">EXPOSE      80</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># 5. 启动应用，指定外部通用库目录 在应用的启动参数，设置 -XX:+UseContainerSupport，设置-XX:MaxRAMPercentage=75.0，这样为其他进程（debug、监控）留下足够的内存空间，又不会太浪费RAM。</span></span></span><br><span class="line"><span class="bash">ENTRYPOINT  [<span class="string">"java"</span>, <span class="string">"-Dloader.path=/lib"</span>, <span class="string">"-jar"</span>, <span class="string">"/app.jar"</span>, <span class="string">"--server.port=80"</span>, <span class="string">"--spring.cloud.nacos.config.namespace=???"</span>]</span></span><br></pre></td></tr></table></figure>
<h4 id="Kube-Pod-资源清单-1"><a href="#Kube-Pod-资源清单-1" class="headerlink" title="Kube Pod 资源清单"></a>Kube Pod 资源清单</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务配置</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 应用名称：easybyte-auth</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$APP_NAME</span></span><br><span class="line">  <span class="comment"># 命名空间（这里区分不同的环境）：easybyte-dev、easybyte-test、easybyte-prod</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">$NAME_SPACE</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">    - protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="comment"># 容器内部端口，服务端口</span></span><br><span class="line"><span class="attr">      targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># pod 端口，容器外部端口，可以重复（每个pod都有一个独立的ip）</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">$NAME_SPACE</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">$DOCKER_REGISTRY/$DOCKER_NAMESPACE/$APP_NAME:$VERSION</span></span><br><span class="line"><span class="attr">          command:</span> <span class="string">[</span> <span class="string">"java"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"-Dloader.path=/lib"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"-XX:+UseContainerSupport"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"-XX:MaxRAMPercentage=75.0"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"-jar"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"/app.jar"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"--server.port=80"</span><span class="string">,</span></span><br><span class="line">                     <span class="string">"--spring.cloud.nacos.config.namespace=$NACOS_GROUP"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line">          <span class="comment"># args: ["--spring.cloud.nacos.config.namespace=$NACOS_GROUP"]</span></span><br><span class="line"><span class="attr">          ports:</span></span><br><span class="line"><span class="attr">            - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">              protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">          terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line"><span class="attr">          terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">          <span class="comment"># 拉取镜像策略，当本地不存在时拉取。</span></span><br><span class="line"><span class="attr">          imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="comment"># 设置时区，Docker默认的是伦敦时区</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">TZ</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="comment"># 容器自动自动（Always：当容器失效时，由kubelet自动重启该容器。OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器。Never：不论容器运行状态如何，kubelet都不会重启该容器。）</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="comment"># 优雅停机毫秒</span></span><br><span class="line"><span class="attr">      terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="comment"># 发布策略（滚动更新）</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">100</span><span class="string">%</span></span><br></pre></td></tr></table></figure>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h4 id="给-SpringBoot-应用动态传参"><a href="#给-SpringBoot-应用动态传参" class="headerlink" title="给 SpringBoot 应用动态传参"></a>给 SpringBoot 应用动态传参</h4><p>在部署 SpringBoot 项目时，需要动态的制定启动参数例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar /app.jar --server.port=80 --spring.cloud.nacos.config.namespace=<span class="variable">$NACOS_GROUP</span></span><br></pre></td></tr></table></figure>
<p>这时候可以在 pod 资源文件配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">$APP_NAME</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">$APP_NAME:$BUILD_NUMBER</span></span><br><span class="line"><span class="attr">          command:</span>  <span class="string">["java",</span> <span class="string">"-jar"</span><span class="string">,</span> <span class="string">"/app.jar"</span><span class="string">,</span> <span class="string">"--server.port=80"</span><span class="string">,</span> <span class="string">"--spring.cloud.nacos.config.namespace=$NACOS_GROUP"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<h4 id="自定义运行-pod-资源文件"><a href="#自定义运行-pod-资源文件" class="headerlink" title="自定义运行 pod 资源文件"></a>自定义运行 pod 资源文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'deploy app to multi cluster'</span>) &#123;</span><br><span class="line">    steps &#123;</span><br><span class="line">        container(<span class="string">'nodejs'</span>) &#123;</span><br><span class="line">            script &#123;</span><br><span class="line">                withCredentials([kubeconfigFile(credentialsId: <span class="string">'multi-cluster'</span>, variable: <span class="string">'KUBECONFIG'</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">'envsubst &lt; devops-go-sample/manifest/multi-cluster-deploy.yaml | kubectl apply -f -'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Jenkinsfile-使用-choice-参数时，修改没有生效"><a href="#Jenkinsfile-使用-choice-参数时，修改没有生效" class="headerlink" title="Jenkinsfile 使用 choice 参数时，修改没有生效"></a>Jenkinsfile 使用 choice 参数时，修改没有生效</h4><p>场景：Jenkinsfile 使用了 choice 参数，总是不生效，且 <code>kubesphere-system.ks-controller-manager</code> 报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">zhangqinghua$ kubectl get pods -n kubesphere-system</span><br><span class="line">kubesphere-system              cluster-agent-76d4f5466-j9shm                                     1/1     Running            0          15d</span><br><span class="line">kubesphere-system              ks-apiserver-689d5cccbf-psnz4                                     1/1     Running            0          6h12m</span><br><span class="line">kubesphere-system              ks-console-6858bfd78c-zkf4j                                       1/1     Running            0          31d</span><br><span class="line">kubesphere-system              ks-controller-manager-7fcb88968-gtdk2                             0/1     CrashLoopBackOff   3          3m14s</span><br><span class="line">kubesphere-system              ks-installer-566dc4c9bd-t7slb                                     1/1     Running            0          7h25m</span><br><span class="line">kubesphere-system              minio-5f49b564fd-tnq7k                                            1/1     Running            2          30d</span><br><span class="line">kubesphere-system              openldap-0                                                        1/1     Running            2          31d</span><br><span class="line">kubesphere-system              tower-8647b6f6d4-2crzd                                            1/1     Running            8          25d</span><br></pre></td></tr></table></figure>
<p>原因：Kubesphere bug。<br>解决：？</p>
<p>参考：<a href="https://github.com/kubesphere/kubesphere/issues?q=is%3Aissue+panic+is%3Aclosed+author%3ALinuxSuRen">相关Issus</a></p>
<p>后续：经过多次测试，这种写法是 OK 的（编辑后运行 2 次才生效）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">parameters &#123;</span><br><span class="line">  choice(name: &apos;APP_NAME&apos;, choices: [&apos;a&apos; , &apos;b&apos; , &apos;c&apos;], description: &apos;123&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="流水线更新应用，deployment安装失败"><a href="#流水线更新应用，deployment安装失败" class="headerlink" title="流水线更新应用，deployment安装失败"></a>流水线更新应用，deployment安装失败</h4><p>场景：Internal error occurred: failed calling webhook “logsidecar-injector.logging.kubesphere.io”: Post <a href="https://logsidecar-injector-admission.kubesphere-logging-system.svc:443/?timeout=30s">https://logsidecar-injector-admission.kubesphere-logging-system.svc:443/?timeout=30s</a>: service “logsidecar-injector-admission” not found</p>
<p>原因：????</p>
<p>解决：kubectl delete MutatingWebhookConfiguration logsidecar-injector-admission-mutate 删除掉这个3.0.0版本的对象</p>
<p>参考：<a href="https://kubesphere.com.cn/forum/d/1978-deployment">https://kubesphere.com.cn/forum/d/1978-deployment</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#限制-DevOps-运行在指定节点"><span class="toc-number">1.</span> <span class="toc-text">限制 DevOps 运行在指定节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建-Vue-应用流水线"><span class="toc-number">2.</span> <span class="toc-text">构建 Vue 应用流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jenkins-配置"><span class="toc-number">2.0.1.</span> <span class="toc-text">jenkins 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile"><span class="toc-number">2.0.2.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kube-Pod-资源清单"><span class="toc-number">2.0.3.</span> <span class="toc-text">Kube Pod 资源清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#构建-SpringCloud-应用流水线"><span class="toc-number">3.</span> <span class="toc-text">构建 SpringCloud 应用流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jenkins-配置-1"><span class="toc-number">3.0.1.</span> <span class="toc-text">jenkins 配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dockerfile-1"><span class="toc-number">3.0.2.</span> <span class="toc-text">Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kube-Pod-资源清单-1"><span class="toc-number">3.0.3.</span> <span class="toc-text">Kube Pod 资源清单</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#常见问题"><span class="toc-number">4.</span> <span class="toc-text">常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#给-SpringBoot-应用动态传参"><span class="toc-number">4.0.1.</span> <span class="toc-text">给 SpringBoot 应用动态传参</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义运行-pod-资源文件"><span class="toc-number">4.0.2.</span> <span class="toc-text">自定义运行 pod 资源文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkinsfile-使用-choice-参数时，修改没有生效"><span class="toc-number">4.0.3.</span> <span class="toc-text">Jenkinsfile 使用 choice 参数时，修改没有生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#流水线更新应用，deployment安装失败"><span class="toc-number">4.0.4.</span> <span class="toc-text">流水线更新应用，deployment安装失败</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&text=KubeSphere DevOps"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&is_video=false&description=KubeSphere DevOps"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KubeSphere DevOps&body=Check out this article: http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&title=KubeSphere DevOps"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/05/13/部署运维/Kubernetes 手册/KubeSphere DevOps/&name=KubeSphere DevOps&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/archives/">Articles</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/search/">Search</a></li>
        
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
