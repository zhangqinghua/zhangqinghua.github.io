<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="公司官网：https://www.icbc.com.mo开发文档：https://app.icbcmo.site/gitbook Login name: ebyte Password: ebyte 工銀澳門聚合支付 Plus。 发起支付请求参考：https://app.icbcmo.site/gitbook/cn/chap4/chap4.html 微信小程序支付123456789101112131">
<meta property="og:type" content="article">
<meta property="og:title" content="聚合支付 Icbcmo">
<meta property="og:url" content="http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="公司官网：https://www.icbc.com.mo开发文档：https://app.icbcmo.site/gitbook Login name: ebyte Password: ebyte 工銀澳門聚合支付 Plus。 发起支付请求参考：https://app.icbcmo.site/gitbook/cn/chap4/chap4.html 微信小程序支付123456789101112131">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210608180002.png">
<meta property="og:updated_time" content="2021-06-27T16:00:18.239Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="聚合支付 Icbcmo">
<meta name="twitter:description" content="公司官网：https://www.icbc.com.mo开发文档：https://app.icbcmo.site/gitbook Login name: ebyte Password: ebyte 工銀澳門聚合支付 Plus。 发起支付请求参考：https://app.icbcmo.site/gitbook/cn/chap4/chap4.html 微信小程序支付123456789101112131">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210608180002.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>聚合支付 Icbcmo</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/04/27/架构设计/支付开发/聚合支付 Stripe/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/04/27/架构设计/支付开发/聚合支付 SwiftPass/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&text=聚合支付 Icbcmo"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&is_video=false&description=聚合支付 Icbcmo"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=聚合支付 Icbcmo&body=Check out this article: http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&name=聚合支付 Icbcmo&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#发起支付请求"><span class="toc-number">1.</span> <span class="toc-text">发起支付请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#微信小程序支付"><span class="toc-number">1.0.1.</span> <span class="toc-text">微信小程序支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#信用卡支付"><span class="toc-number">1.0.2.</span> <span class="toc-text">信用卡支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#支付请求"><span class="toc-number">1.0.3.</span> <span class="toc-text">支付请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#支付结果异步通知"><span class="toc-number">2.</span> <span class="toc-text">支付结果异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知参数"><span class="toc-number">2.0.1.</span> <span class="toc-text">异步通知参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知接收方法"><span class="toc-number">2.0.2.</span> <span class="toc-text">异步通知接收方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知处理方法"><span class="toc-number">2.0.3.</span> <span class="toc-text">异步通知处理方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起主动查询"><span class="toc-number">3.</span> <span class="toc-text">发起主动查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#请求参数"><span class="toc-number">3.0.1.</span> <span class="toc-text">请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#响应数据"><span class="toc-number">3.0.2.</span> <span class="toc-text">响应数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#请求方法"><span class="toc-number">3.0.3.</span> <span class="toc-text">请求方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起退款申请"><span class="toc-number">4.</span> <span class="toc-text">发起退款申请</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数"><span class="toc-number">4.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数"><span class="toc-number">4.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法"><span class="toc-number">4.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#退款结果异步通知"><span class="toc-number">5.</span> <span class="toc-text">退款结果异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知参数-1"><span class="toc-number">5.0.1.</span> <span class="toc-text">异步通知参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步接收方法"><span class="toc-number">5.0.2.</span> <span class="toc-text">异步接收方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步处理方法"><span class="toc-number">5.0.3.</span> <span class="toc-text">异步处理方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起退款查询"><span class="toc-number">6.</span> <span class="toc-text">发起退款查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数-1"><span class="toc-number">6.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数-1"><span class="toc-number">6.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法-1"><span class="toc-number">6.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关闭订单"><span class="toc-number">7.</span> <span class="toc-text">关闭订单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数-2"><span class="toc-number">7.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数-2"><span class="toc-number">7.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法-2"><span class="toc-number">7.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载对账文件"><span class="toc-number">8.</span> <span class="toc-text">下载对账文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用方法"><span class="toc-number">9.</span> <span class="toc-text">通用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#将-Map-转换成为请求参数"><span class="toc-number">9.0.1.</span> <span class="toc-text">将 Map 转换成为请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计算签名"><span class="toc-number">9.0.2.</span> <span class="toc-text">计算签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#渠道擴展字段"><span class="toc-number">9.0.3.</span> <span class="toc-text">渠道擴展字段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#响应数据-1"><span class="toc-number">10.</span> <span class="toc-text">响应数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#發起支付请求"><span class="toc-number">10.0.1.</span> <span class="toc-text">發起支付请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#发起退款申请-1"><span class="toc-number">10.0.2.</span> <span class="toc-text">发起退款申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#退款结果异步通知-1"><span class="toc-number">10.0.3.</span> <span class="toc-text">退款结果异步通知</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商户异常"><span class="toc-number">11.</span> <span class="toc-text">商户异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附：簽名測試接口"><span class="toc-number">12.</span> <span class="toc-text">附：簽名測試接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附：测试卡号和查询短信验证码"><span class="toc-number">13.</span> <span class="toc-text">附：测试卡号和查询短信验证码</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        聚合支付 Icbcmo
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Hexo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-04-27T00:00:56.000Z" itemprop="datePublished">2021-04-27</time>
        
        (Updated: <time datetime="2021-06-27T16:00:18.239Z" itemprop="dateModified">2021-06-27</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/架构设计/">架构设计</a> › <a class="category-link" href="/categories/架构设计/支付开发/">支付开发</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>公司官网：<a href="https://www.icbc.com.mo">https://www.icbc.com.mo</a><br>开发文档：<a href="https://app.icbcmo.site/gitbook">https://app.icbcmo.site/gitbook</a> Login name: ebyte Password: ebyte</p>
<p>工銀澳門聚合支付 Plus。</p>
<h2 id="发起支付请求"><a href="#发起支付请求" class="headerlink" title="发起支付请求"></a>发起支付请求</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap4/chap4.html">https://app.icbcmo.site/gitbook/cn/chap4/chap4.html</a></p>
<h4 id="微信小程序支付"><a href="#微信小程序支付" class="headerlink" title="微信小程序支付"></a>微信小程序支付</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PayInfo <span class="title">orderWechatMiniApp</span><span class="params">(Long orderId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 查询订单</span></span><br><span class="line">    Order order = orderFeign.one(attr(Order::getMerchantId, Order::getMemberId, Order::getCode, Order::getPayment), id(orderId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 查询支付配置</span></span><br><span class="line">    ReceiptConfig.IcbcmoWeixinJsapi icbcmoWeixinJsapi = receiptConfigFeign.icbcmoWeixinJsapi(order.getMerchantId());</span><br><span class="line">    IcbcmoConfig icbcmoConfig = BeanMapper.map(icbcmoWeixinJsapi, IcbcmoConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 查询支付的微信openId</span></span><br><span class="line">    String openId = memberFeign.openId(order.getMemberId());</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(openId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(I18n2.warn_pay_1000001.locale());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 发起支付请求</span></span><br><span class="line">    <span class="keyword">return</span> order(order, icbcmoConfig, <span class="string">"WechatMiniApp"</span>, weixinChannelExt(icbcmoWeixinJsapi.getWx_appid(), openId));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="信用卡支付"><a href="#信用卡支付" class="headerlink" title="信用卡支付"></a>信用卡支付</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PayInfo <span class="title">orderIcbcOnlinePosOrder</span><span class="params">(Long orderId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 查询订单</span></span><br><span class="line">    Order order = orderFeign.one(attr(Order::getMerchantId, Order::getCode, Order::getPayment), id(orderId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 查询支付配置</span></span><br><span class="line">    ReceiptConfig.IcbcmoPos icbcmoPos = receiptConfigFeign.icbcmoPos(order.getMerchantId());</span><br><span class="line">    IcbcmoConfig icbcmoConfig = BeanMapper.map(icbcmoPos, IcbcmoConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 发起支付请求</span></span><br><span class="line">    <span class="keyword">return</span> order(order, icbcmoConfig, <span class="string">"ICBCOnlinePosOrder"</span>, postChannelExt());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="支付请求"><a href="#支付请求" class="headerlink" title="支付请求"></a>支付请求</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PayInfo <span class="title">order</span><span class="params">(Order order, IcbcmoConfig icbcmoConfig, String channel, String channelExt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 校验配置</span></span><br><span class="line">        icbcmoProperties.valid();</span><br><span class="line">        <span class="comment">// 2. 一些字段</span></span><br><span class="line">        String amount = String.valueOf(order.getPayment().multiply(BigDecimal.valueOf(<span class="number">100</span>)).intValue());</span><br><span class="line">        String md5Key = icbcmoConfig.getMd5Key();</span><br><span class="line">        String merchantOrderId = order.getCode();</span><br><span class="line">        String returnUrl = icbcmoProperties.getReturnUrl();</span><br><span class="line">        String notifyUrl = icbcmoProperties.getOrderNotifySite() + <span class="string">"/api/icbcmo/pay/notify"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 请求参数</span></span><br><span class="line">        TreeMap&lt;String, String&gt; params = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"merchantId"</span>, icbcmoConfig.getMerchantId());         <span class="comment">// （必填）商戶號</span></span><br><span class="line">        params.put(<span class="string">"merchantTid"</span>, icbcmoConfig.getMerchantTid());       <span class="comment">// （选填）商戶設備ID只適用於微信/支付寶</span></span><br><span class="line">        params.put(<span class="string">"channel"</span>, channel);                                 <span class="comment">// （必填）取值範圍請參考支付請求 channel 參數信息表</span></span><br><span class="line">        params.put(<span class="string">"merchantOrderId"</span>, merchantOrderId);                 <span class="comment">// （必填）商戶訂單ID</span></span><br><span class="line">        params.put(<span class="string">"merchantUserId"</span>, <span class="string">""</span>);                               <span class="comment">// （选填）商户的客户ID（仅线上POS使用）</span></span><br><span class="line">        params.put(<span class="string">"currency"</span>, <span class="string">"MOP"</span>);                                  <span class="comment">// （必填）貨幣（固定MOP）</span></span><br><span class="line">        params.put(<span class="string">"amount"</span>, amount);                                   <span class="comment">// （必填）額（分）</span></span><br><span class="line">        params.put(<span class="string">"timeout"</span>, <span class="string">"900"</span>);                                   <span class="comment">// （必填）超時時間（秒）（需要設置白名單才有效，該字段用來設置支付超時時間，沒有設置該值的情況，該值默認900秒，如果設置該值，選擇渠道為線上POS，超時支付之後系統會自動沖正退款）</span></span><br><span class="line">        params.put(<span class="string">"notifyUrl"</span>, notifyUrl);                             <span class="comment">// （选填）通知支付接口</span></span><br><span class="line">        params.put(<span class="string">"returnUrl"</span>, returnUrl);                             <span class="comment">// （必填）前端回調接口</span></span><br><span class="line">        params.put(<span class="string">"channelExt"</span>, channelExt);                           <span class="comment">// （选填）渠道擴展字段, 必須為JSON格式</span></span><br><span class="line">        params.put(<span class="string">"merchantExt"</span>, <span class="string">""</span>);                                  <span class="comment">// （选填）商戶擴展字段該為保留字段, 無任何限制, 內容不會被處理</span></span><br><span class="line">        params.put(<span class="string">"sign"</span>, sign(md5Key, params));                       <span class="comment">// （必填）簽名用於校驗參數是否被篡改</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 转换成为请求参数 a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String queryStr = queryStr(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 组装接口地址 https://app.icbcmo.site/api/v1/order?a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String request = icbcmoProperties.getUrl() + <span class="string">"/api/v1/order?"</span> + queryStr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 请求接口</span></span><br><span class="line">        log.info(<span class="string">"IcbcmoService.order Request: "</span> + request);</span><br><span class="line">        String response = Request.Post(request)</span><br><span class="line">                                    .addHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</span><br><span class="line">                                    .execute()</span><br><span class="line">                                    .returnContent().toString();</span><br><span class="line">        log.info(<span class="string">"IcbcmoService.order Response: "</span> + response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 结果处理  &#123;"code":"9998","retCode":"500","msg":"channel 請求參數不合法"&#125;</span></span><br><span class="line">        JSONObject responseJSON = JSONObject.parseObject(response);</span><br><span class="line">        <span class="keyword">if</span> (!responseJSON.getString(<span class="string">"retCode"</span>).equals(<span class="string">"200"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(responseJSON.getString(<span class="string">"msg"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.1 微信小程序支付</span></span><br><span class="line">        JSONObject returnObj = responseJSON.getJSONObject(<span class="string">"returnObj"</span>);</span><br><span class="line">        <span class="keyword">if</span> (returnObj.getString(<span class="string">"channel"</span>).equals(<span class="string">"WechatMiniApp"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!returnObj.getString(<span class="string">"respCode"</span>).equals(<span class="string">"00"</span>)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(returnObj.getString(<span class="string">"respMsgDetail"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            PayInfo payInfo = <span class="keyword">new</span> PayInfo();</span><br><span class="line">            PayInfo.WeixinJSAPI weixinJSAPI = <span class="keyword">new</span> PayInfo.WeixinJSAPI();</span><br><span class="line">            weixinJSAPI.setAppId(returnObj.getString(<span class="string">"appId"</span>));</span><br><span class="line">            weixinJSAPI.setPaySign(returnObj.getString(<span class="string">"sign"</span>));</span><br><span class="line">            weixinJSAPI.setSignType(returnObj.getString(<span class="string">"signType"</span>));</span><br><span class="line">            weixinJSAPI.setNonceStr(returnObj.getString(<span class="string">"nonceStr"</span>));</span><br><span class="line">            weixinJSAPI.setTimestamp(returnObj.getString(<span class="string">"timeStamp"</span>));</span><br><span class="line">            weixinJSAPI.setPackageDesc(returnObj.getString(<span class="string">"package"</span>));</span><br><span class="line">            payInfo.setWeixinJSAPI(weixinJSAPI);</span><br><span class="line">            <span class="keyword">return</span> payInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.2 POS支付</span></span><br><span class="line">        <span class="keyword">if</span> (returnObj.getString(<span class="string">"channel"</span>).equals(<span class="string">"ICBCOnlinePosOrder"</span>)) &#123;</span><br><span class="line">            PayInfo payInfo = <span class="keyword">new</span> PayInfo();</span><br><span class="line">            PayInfo.Pos pos = <span class="keyword">new</span> PayInfo.Pos();</span><br><span class="line">            pos.setRedirectUrl(returnObj.getString(<span class="string">"redirectUrl"</span>));</span><br><span class="line">            pos.setAgentRedirectUrl(replaceDomainAndPort(icbcmoProperties.getAgentPosPaySite(), pos.getRedirectUrl()));</span><br><span class="line">            payInfo.setPos(pos);</span><br><span class="line">            <span class="keyword">return</span> payInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.3 其它异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"Unknow Error"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="支付结果异步通知"><a href="#支付结果异步通知" class="headerlink" title="支付结果异步通知"></a>支付结果异步通知</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap6/chap6.html">https://app.icbcmo.site/gitbook/cn/chap6/chap6.html</a></p>
<h4 id="异步通知参数"><a href="#异步通知参数" class="headerlink" title="异步通知参数"></a>异步通知参数</h4><p><strong>1. 异常参数</strong><br>原始回调数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dev.easybyte-hk.com/api/icbcmo/pay/notify&amp;amount=5&amp;channel=ICBCOnlinePosOrder&amp;channelTransId=HFG000000000000012264583&amp;currency=MOP&amp;icbcOrderId=001IC20210610174515370150881&amp;merchantExt=%7B%22remark1%22%3A%22625018******1479%7C6%7C2%7C0%22%2C%22remark2%22%3A%22%3F%3F%3F%3F%22%7D&amp;merchantId=011901200001005&amp;merchantOrderId=20210610170740444269&amp;merchantTid=00000001&amp;result=Error&amp;resultMsg=93000128%7C%E8%B6%85%E4%B8%83%E6%97%A5%E6%B6%88%E8%B4%B9%E7%AC%94%E6%95%B0%E7%B4%AF%E8%AE%A1+%E8%AF%B7%E8%AE%B0%E5%BD%95%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%8F%8A%E6%97%B6%E4%B8%8E%E6%88%91%E8%A1%8C%E5%AE%A2%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%83%A8%E9%97%A8%E8%81%94%E7%B3%BB%E3%80%82&amp;sign=aab1cab2f80e48fa4af680a5d788038c</span><br></pre></td></tr></table></figure>
<p>解析后的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">merchantExt=&#123;&quot;remark1&quot;:&quot;625018******1479|6|2|0&quot;,&quot;remark2&quot;:&quot;????&quot;&#125;, </span><br><span class="line">result=Error, </span><br><span class="line">amount=5, </span><br><span class="line">merchantId=011901200001005, </span><br><span class="line">channel=ICBCOnlinePosOrder, </span><br><span class="line">sign=aab1cab2f80e48fa4af680a5d788038c, </span><br><span class="line">currency=MOP, </span><br><span class="line">merchantOrderId=20210610170740444269, </span><br><span class="line">icbcOrderId=001IC20210610174515370150881, </span><br><span class="line">merchantTid=00000001, </span><br><span class="line">channelTransId=HFG000000000000012264583, </span><br><span class="line">resultMsg=93000128|超七日消费笔数累计 请记录错误代码，及时与我行客户服务部门联系。</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">merchantExt=&#123;&quot;remark1&quot;:&quot;625018******1479|6|2|0&quot;,&quot;remark2&quot;:&quot;????&quot;&#125;, </span><br><span class="line">result=Error, </span><br><span class="line">amount=7, </span><br><span class="line">merchantId=011901200001005, </span><br><span class="line">channel=ICBCOnlinePosOrder, </span><br><span class="line">sign=4110e3ffb1975ce1c99135383df643ee, </span><br><span class="line">currency=MOP, </span><br><span class="line">merchantOrderId=20210621114823813766, </span><br><span class="line">icbcOrderId=001IC20210621114826045985355, </span><br><span class="line">merchantTid=00000001, </span><br><span class="line">channelTransId=HFG000000000000012265945, </span><br><span class="line">resultMsg=8268|系統錯誤，請聯繫工行 請記錄錯誤代碼，及時與我行客戶服務部門聯繫</span><br></pre></td></tr></table></figure>
<p><strong>1. 微信支付回调</strong></p>
<p>原始回调数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dev.easybyte-hk.com/api/icbcmo/pay/notify&amp;amount=5&amp;channel=WechatMiniApp&amp;channelTransId=4200001159202106101341217912&amp;currency=MOP&amp;icbcOrderId=011WE20210610103250045862338&amp;merchantId=011900000000002&amp;merchantOrderId=20210610103246168335&amp;merchantTid=00000011&amp;result=Success&amp;resultMsg=success&amp;sign=005e94348fd2deffa5836b26461f21e8</span><br></pre></td></tr></table></figure>
<p>解析后的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">result=Success, </span><br><span class="line">amount=5, </span><br><span class="line">merchantId=011900000000002, </span><br><span class="line">channel=WechatMiniApp, </span><br><span class="line">sign=005e94348fd2deffa5836b26461f21e8, </span><br><span class="line">currency=MOP, </span><br><span class="line">merchantOrderId=20210610103246168335, </span><br><span class="line">icbcOrderId=011WE20210610103250045862338, </span><br><span class="line">merchantTid=00000011, </span><br><span class="line">channelTransId=4200001159202106101341217912, </span><br><span class="line">resultMsg=success</span><br></pre></td></tr></table></figure>
<p><strong>2. POS 支付回调</strong></p>
<p>原始回调数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dev.easybyte-hk.com/api/icbcmo/pay/notify&amp;amount=1205&amp;channel=ICBCOnlinePosOrder&amp;channelTransId=HFG000000000000012264401&amp;currency=MOP&amp;icbcOrderId=001IC20210610144458507737894&amp;merchantExt=%7B%22remark1%22%3A%22625018******6308%7C6%7C2%7C0%22%2C%22remark2%22%3A%22%3F%3F%3F%3F%22%7D&amp;merchantId=011901200001005&amp;merchantOrderId=20210610144456805106&amp;merchantTid=00000001&amp;result=Success&amp;resultMsg=0%7C&amp;sign=bf00d2e0d9f03da7d205b4a2a40b7343</span><br></pre></td></tr></table></figure>
<p>解析后的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">merchantExt=&#123;&quot;remark1&quot;:&quot;625018******6308|6|2|0&quot;,&quot;remark2&quot;:&quot;????&quot;&#125;, </span><br><span class="line">result=Success, </span><br><span class="line">amount=1205, </span><br><span class="line">merchantId=011901200001005, </span><br><span class="line">channel=ICBCOnlinePosOrder, </span><br><span class="line">sign=bf00d2e0d9f03da7d205b4a2a40b7343, </span><br><span class="line">currency=MOP, </span><br><span class="line">merchantOrderId=20210610144456805106, </span><br><span class="line">icbcOrderId=001IC20210610144458507737894, </span><br><span class="line">merchantTid=00000001, </span><br><span class="line">channelTransId=HFG000000000000012264401, </span><br><span class="line">resultMsg=0|</span><br></pre></td></tr></table></figure>
<h4 id="异步通知接收方法"><a href="#异步通知接收方法" class="headerlink" title="异步通知接收方法"></a>异步通知接收方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/pay/notify"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">payNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 解析回调参数</span></span><br><span class="line">    log.info(<span class="string">"ICBCMO 原始支付回调参数：&#123;&#125;&#123;&#125;&#123;&#125;"</span>, request.getRequestURL(), <span class="string">"&amp;"</span>, request.getQueryString());</span><br><span class="line">    Enumeration&lt;String&gt; names = request.getParameterNames();</span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">        String name = names.nextElement();</span><br><span class="line">        String value = request.getParameter(name);</span><br><span class="line">        params.put(name, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 处理支付回调 todo 应该异步处理</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">"ICBCMO 解析支付回调参数：&#123;&#125;"</span>, params);</span><br><span class="line">        icbcmoService.syncOrderNotiry(params);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"ICBCMO 处理支付回调异常：&#123;&#125;"</span>, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 返回success以確認完成通知成功（不管有没有处理成功）</span></span><br><span class="line">    <span class="meta">@Cleanup</span></span><br><span class="line">    PrintWriter printWriter = response.getWriter();</span><br><span class="line">    printWriter.write(<span class="string">"success"</span>);</span><br><span class="line">    printWriter.flush();</span><br><span class="line">    printWriter.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="异步通知处理方法"><a href="#异步通知处理方法" class="headerlink" title="异步通知处理方法"></a>异步通知处理方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">syncOrderNotiry</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 校验参数</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"Success"</span>.equals(params.get(<span class="string">"result"</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"result异常："</span> + params.get(<span class="string">"result"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 渠道类型、支付类型（WechatMiniApp）</span></span><br><span class="line">        String channel = params.get(<span class="string">"channel"</span>);</span><br><span class="line">        <span class="comment">// 3. 商户订单号（20210610103246168335）</span></span><br><span class="line">        String orderCode = params.get(<span class="string">"merchantOrderId"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 计算支付类型</span></span><br><span class="line">        PayEnum payEnum = <span class="string">"WechatMiniApp"</span>.equals(params.get(<span class="string">"channel"</span>)) ? PayEnum.weixin :</span><br><span class="line">                            <span class="string">"ICBCOnlinePosOrder"</span>.equals(params.get(<span class="string">"channel"</span>)) ? PayEnum.pos :</span><br><span class="line">                            <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (payEnum == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"非法的支付类型："</span> + params.get(<span class="string">"channel"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 设置订单支付成功</span></span><br><span class="line">        orderFeign.paid(orderCode, payEnum, PayAgent.icbcmo, LocalDateTime.now());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="发起主动查询"><a href="#发起主动查询" class="headerlink" title="发起主动查询"></a>发起主动查询</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap6/chap6.html">https://app.icbcmo.site/gitbook/cn/chap6/chap6.html</a></p>
<h4 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://app.icbcmo.site/api/v1/query?merchantId=011900000000002&amp;merchantOrderId=20210604155233849229&amp;sign=c5696f38c847aa0b53b9e105f04bf985</span><br></pre></td></tr></table></figure>
<h4 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h4><p><strong>1. 异常响应</strong><br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"1095"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"查無此訂單，請核實, Check this order, please verify"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000001"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210610170740444269"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001IC20210610174515370150881"</span>, </span><br><span class="line">        <span class="attr">"channelTransId"</span>: <span class="string">"HFG000000000000012264583"</span>, </span><br><span class="line">        <span class="attr">"customer_user_id"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"orderStatus"</span>: <span class="string">"Error"</span>, </span><br><span class="line">        <span class="attr">"orderStatusDesc"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"ICBCOnlinePosOrder"</span>, </span><br><span class="line">        <span class="attr">"orderCurrency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"orderAmount"</span>: <span class="string">"5"</span>, </span><br><span class="line">        <span class="attr">"discountAmount"</span>: <span class="string">"0"</span>, </span><br><span class="line">        <span class="attr">"cashCurrency"</span>: <span class="string">"81"</span>, </span><br><span class="line">        <span class="attr">"cashAmount"</span>: <span class="string">"5"</span>, </span><br><span class="line">        <span class="attr">"bankType"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"receipt_amount"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"tradeTime"</span>: <span class="string">"2021-06-10 17:46:40"</span>, </span><br><span class="line">        <span class="attr">"errorCode"</span>: <span class="string">"0"</span>, </span><br><span class="line">        <span class="attr">"errorMessage"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"cardNo"</span>: <span class="string">"625018******1479"</span>, </span><br><span class="line">        <span class="attr">"cardType"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"merchantExt"</span>: <span class="string">"&#123;\"remark1\":\"625018******6308|6|2|0\",\"remark2\":\"????\"&#125;"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"399c4fc7950259040790dd422abc97f0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 支付宝响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"retCode"</span>: <span class="string">"200"</span>,</span><br><span class="line">  <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">    <span class="attr">"merchantId"</span>: <span class="string">"011901200001001"</span>,</span><br><span class="line">    <span class="attr">"merchantTid"</span>: <span class="string">"00000011"</span>,</span><br><span class="line">    <span class="attr">"merchantOrderId"</span>: <span class="string">"ICBC_AIO_20190710_233100"</span>,</span><br><span class="line">    <span class="attr">"icbcOrderId"</span>: <span class="string">"011AL20190710233158379876488"</span>,</span><br><span class="line">    <span class="attr">"channelTransId"</span>: <span class="string">"2019071022001330371041428517"</span>,</span><br><span class="line">    <span class="attr">"orderStatus"</span>: <span class="string">"Success"</span>,</span><br><span class="line">    <span class="attr">"orderStatusDesc"</span>: <span class="string">"支付成功"</span>,</span><br><span class="line">    <span class="attr">"channel"</span>: <span class="string">"AlipayWEB"</span>,</span><br><span class="line">    <span class="attr">"orderCurrency"</span>: <span class="string">"MOP"</span>,</span><br><span class="line">    <span class="attr">"orderAmount"</span>: <span class="string">"5"</span>,</span><br><span class="line">    <span class="attr">"cashCurrency"</span>: <span class="string">"CNY"</span>,</span><br><span class="line">    <span class="attr">"cashAmount"</span>: <span class="string">"4"</span>,</span><br><span class="line">    <span class="attr">"bankType"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"tradeTime"</span>: <span class="string">"2019-07-10 23:32:21"</span>,</span><br><span class="line">    <span class="attr">"errorCode"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"errorMessage"</span>: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sign"</span>: <span class="string">"4e349f7fa5ec47f5321ab967edc6bc8c"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. 微信支付响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011900000000002"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000011"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210607103609472187"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"011WE20210607103617064565574"</span>, </span><br><span class="line">        <span class="attr">"channelTransId"</span>: <span class="string">"4200001030202106070520800740"</span>, </span><br><span class="line">        <span class="attr">"customer_user_id"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"orderStatus"</span>: <span class="string">"Success"</span>, </span><br><span class="line">        <span class="attr">"orderStatusDesc"</span>: <span class="string">"支付成功"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"WechatMiniApp"</span>, </span><br><span class="line">        <span class="attr">"orderCurrency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"orderAmount"</span>: <span class="string">"6"</span>, </span><br><span class="line">        <span class="attr">"discountAmount"</span>: <span class="string">"0"</span>, </span><br><span class="line">        <span class="attr">"cashCurrency"</span>: <span class="string">"CNY"</span>, </span><br><span class="line">        <span class="attr">"cashAmount"</span>: <span class="string">"4"</span>, </span><br><span class="line">        <span class="attr">"bankType"</span>: <span class="string">"PAB_CREDIT"</span>, </span><br><span class="line">        <span class="attr">"receipt_amount"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"tradeTime"</span>: <span class="string">"2021-06-07 10:37:18"</span>, </span><br><span class="line">        <span class="attr">"errorCode"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"errorMessage"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"cardNo"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"cardType"</span>: <span class="string">""</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"e8080adfff9d1aeaec416948abf299fa"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. POS 支付响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000001"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210610144456805106"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001IC20210610144458507737894"</span>, </span><br><span class="line">        <span class="attr">"channelTransId"</span>: <span class="string">"HFG000000000000012264401"</span>, </span><br><span class="line">        <span class="attr">"customer_user_id"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"orderStatus"</span>: <span class="string">"Success"</span>, </span><br><span class="line">        <span class="attr">"orderStatusDesc"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"ICBCOnlinePosOrder"</span>, </span><br><span class="line">        <span class="attr">"orderCurrency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"orderAmount"</span>: <span class="string">"1205"</span>, </span><br><span class="line">        <span class="attr">"discountAmount"</span>: <span class="string">"0"</span>, </span><br><span class="line">        <span class="attr">"cashCurrency"</span>: <span class="string">"81"</span>, </span><br><span class="line">        <span class="attr">"cashAmount"</span>: <span class="string">"1205"</span>, </span><br><span class="line">        <span class="attr">"bankType"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"receipt_amount"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"tradeTime"</span>: <span class="string">"2021-06-10 14:45:37"</span>, </span><br><span class="line">        <span class="attr">"errorCode"</span>: <span class="string">"0"</span>, </span><br><span class="line">        <span class="attr">"errorMessage"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"cardNo"</span>: <span class="string">"625018******6308"</span>, </span><br><span class="line">        <span class="attr">"cardType"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"merchantExt"</span>: <span class="string">"&#123;\"remark1\":\"625018******6308|6|2|0\",\"remark2\":\"????\"&#125;"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"f9caf885ca2c5d5b985a88bcdf4f2a13"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TradeQuery <span class="title">query</span><span class="params">(Long orderId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 查询订单数据</span></span><br><span class="line">    Order order = orderFeign.one(id(orderId), attr(Order::getMerchantId, Order::getCode));</span><br><span class="line">    <span class="comment">// 2. 查询支付配置（可能进行多次查询，因为不清楚此订单是使用哪种方式进行支付）</span></span><br><span class="line">    List&lt;IcbcmoConfig&gt; icbcmoConfigs = BeanMapper.map(receiptConfigFeign.icbcmos(order.getMerchantId()), IcbcmoConfig.class);</span><br><span class="line">    <span class="keyword">for</span> (IcbcmoConfig icbcmoConfig : icbcmoConfigs) &#123;</span><br><span class="line">        TradeQuery tradeQuery = query(order, icbcmoConfig);</span><br><span class="line">        <span class="keyword">if</span> (tradeQuery.getTradeState() == TradeStatus.SUCCESS) <span class="keyword">return</span> tradeQuery;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TradeQuery.notpay();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> TradeQuery <span class="title">query</span><span class="params">(Order order, IcbcmoConfig icbcmoConfig)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 3. 组装请求参数</span></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"merchantId"</span>, icbcmoConfig.getMerchantId());         <span class="comment">// （必填）商戶號</span></span><br><span class="line">        params.put(<span class="string">"icbcOrderId"</span>, <span class="string">""</span>);                                  <span class="comment">// （选填）ICBC訂單ID註: icbcOrderId, merchantOrderId: 2選1。處理次序為icbcOrderIdàmerchantOrderId</span></span><br><span class="line">        params.put(<span class="string">"merchantOrderId"</span>, order.getCode());                 <span class="comment">// （选填）商戶訂單ID 註: icbcOrderId, merchantOrderId: 2選1。處理次序為icbcOrderIdàmerchantOrderId</span></span><br><span class="line">        params.put(<span class="string">"sign"</span>, sign(icbcmoConfig.getMd5Key(), params));     <span class="comment">// （必填）簽名用於校驗參數是否被篡改</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 转换成为请求参数 a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String queryStr = queryStr(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 组装接口地址 https://app.icbcmo.site/api/v1/order?a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String request = icbcmoProperties.getUrl() + <span class="string">"/api/v1/query?"</span> + queryStr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6 请求接口</span></span><br><span class="line">        log.info(<span class="string">"IcbcmoService.query Request: \n"</span> + request);</span><br><span class="line">        String response = Request.Get(request)</span><br><span class="line">                                    .execute()</span><br><span class="line">                                    .returnContent().toString();</span><br><span class="line">        log.info(<span class="string">"IcbcmoService.query Response: \n"</span> + response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 响应数据校验</span></span><br><span class="line">        JSONObject responseJSON = JSONObject.parseObject(response);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"200"</span>.equals(responseJSON.getString(<span class="string">"retCode"</span>))) &#123;</span><br><span class="line">            JSONObject returnObj = responseJSON.getJSONObject(<span class="string">"returnObj"</span>);</span><br><span class="line">            <span class="comment">// 7.1 其它状态都算未支付（Create、Wait、Processing、Close、Error、Refund、Reverse）</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"Success"</span>.equals(returnObj.getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                <span class="keyword">return</span> TradeQuery.notpay();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 7.2 支付成功</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"Success"</span>.equals(returnObj.getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                PayEnum payEnum = <span class="string">"AlipayWEB"</span>.equals(returnObj.getString(<span class="string">"channel"</span>)) ? PayEnum.alipay :</span><br><span class="line">                                    <span class="string">"WechatMiniApp"</span>.equals(returnObj.getString(<span class="string">"channel"</span>)) ? PayEnum.weixin :</span><br><span class="line">                                    PayEnum.pos;</span><br><span class="line">                <span class="keyword">return</span> TradeQuery.success(payEnum,</span><br><span class="line">                                            PayAgent.icbcmo,</span><br><span class="line">                                            LocalDateTime.parse(returnObj.getString(<span class="string">"tradeTime"</span>),</span><br><span class="line">                                                                DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.3 订单不存在</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"1095"</span>.equals(responseJSON.getString(<span class="string">"code"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> TradeQuery.notExists();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7.4 其它异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"Unknow Error"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="发起退款申请"><a href="#发起退款申请" class="headerlink" title="发起退款申请"></a>发起退款申请</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap7/chap7.html">https://app.icbcmo.site/gitbook/cn/chap7/chap7.html</a></p>
<p>发起退款申请，微信及支付宝订单为异步接口，需要通过 notifyUrl 异步通知或查询接口确认退款结果。线上 POS 及 e 支付为实时接口，退款接口报文会直接返回退款结果。</p>
<h4 id="上送参数"><a href="#上送参数" class="headerlink" title="上送参数"></a>上送参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.175.59.29:10443/gwinternet/app-svc/api/v1/refund/initRefund?currency=MOP&amp;merchantId=011901200001005&amp;merchantOrderId=20210610112716186705&amp;merchantRefundOrderId=20210610113232421507&amp;notifyUrl=https%3A%2F%2Fdev.easybyte-hk.com%2Fapi%2Ftest&amp;originAmount=1205&amp;refundAmount=1205&amp;sign=8d7eb9883518e6b33ea1661947e2c4f1</span><br></pre></td></tr></table></figure>
<h4 id="返回参数"><a href="#返回参数" class="headerlink" title="返回参数"></a>返回参数</h4><p><strong>1. 异常参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011900000000002"</span>, </span><br><span class="line">        <span class="attr">"refundStatus"</span>: <span class="string">"Fail"</span>, </span><br><span class="line">        <span class="attr">"refundStatusDesc"</span>: <span class="string">"申请退款失败，商家无权限"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"2ec7ca078ca1c3f5bafdf467ce794c7a"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011900000000002"</span>, </span><br><span class="line">        <span class="attr">"refundStatus"</span>: <span class="string">"Fail"</span>, </span><br><span class="line">        <span class="attr">"refundStatusDesc"</span>: <span class="string">"申请退款失败，商家单号无法在系统中找到原交易,请联系机构处理"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"722f348b8bfa035c5185bcc6b2589ee5"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 正常参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011900000000002"</span>, </span><br><span class="line">        <span class="attr">"refundStatus"</span>: <span class="string">"Applied"</span>, </span><br><span class="line">        <span class="attr">"refundStatusDesc"</span>: <span class="string">"退款申请成功，请等待系统后台处理"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"3d86ba5224988993293d4417ca9c697b"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"refundStatus"</span>: <span class="string">"Success"</span>, </span><br><span class="line">        <span class="attr">"refundStatusDesc"</span>: <span class="string">"退货成功"</span>, </span><br><span class="line">        <span class="attr">"refundRealCurrency"</span>: <span class="string">"81"</span>, </span><br><span class="line">        <span class="attr">"refundRealAmount"</span>: <span class="string">"1205"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"e84585523e82e2680da518720496dc83"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上送方法"><a href="#上送方法" class="headerlink" title="上送方法"></a>上送方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initRefund</span><span class="params">(Long refundId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 查询退款订单</span></span><br><span class="line">        Refund refund = refundFeign.one(id(refundId), attr(Refund::getCode, Refund::getOrderId, Refund::getAgreeAmount));</span><br><span class="line">        <span class="comment">// 1. 查询订单数据</span></span><br><span class="line">        Order order = orderFeign.one(id(refund.getOrderId()), attr(Order::getMerchantId, Order::getCode, Order::getPayment, Order::getPayEnum));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 查询支付配置</span></span><br><span class="line">        IcbcmoConfig icbcmoConfig = icbcmoConfig(order.getMerchantId(), order.getPayEnum());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 支付退款金额</span></span><br><span class="line">        String notifyUrl = icbcmoProperties.getRefundNotifySite() + <span class="string">"/api/icbcmo/refund/notify"</span>;</span><br><span class="line">        String originAmount = String.valueOf(order.getPayment().multiply(BigDecimal.valueOf(<span class="number">100</span>)).intValue());</span><br><span class="line">        String refundAmount = String.valueOf(refund.getAgreeAmount().multiply(BigDecimal.valueOf(<span class="number">100</span>)).intValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 组装退款参数</span></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"merchantId"</span>, icbcmoConfig.getMerchantId());         <span class="comment">// （必填）商戶號</span></span><br><span class="line">        params.put(<span class="string">"merchantOrderId"</span>, order.getCode());                 <span class="comment">// （选填）商戶訂單號 註: merchantOrderId, icbcOrderId: 2選1</span></span><br><span class="line">        params.put(<span class="string">"icbcOrderId"</span>, <span class="string">""</span>);                                  <span class="comment">// （选填）ICBC訂單號 註: merchantOrderId, icbcOrderId: 2選1</span></span><br><span class="line">        params.put(<span class="string">"merchantRefundOrderId"</span>, refund.getCode());          <span class="comment">// （必填）退款號（發起退款的商戶生成，需唯一，長度不超過30位）</span></span><br><span class="line">        params.put(<span class="string">"currency"</span>, <span class="string">"MOP"</span>);                                  <span class="comment">// （必填）貨幣（固定MOP）</span></span><br><span class="line">        params.put(<span class="string">"originAmount"</span>, originAmount);                       <span class="comment">// （必填）原始金額（單位：分）</span></span><br><span class="line">        params.put(<span class="string">"refundAmount"</span>, refundAmount);                       <span class="comment">// （必填）退款金額（單位：分）</span></span><br><span class="line">        params.put(<span class="string">"notifyUrl"</span>, notifyUrl);                             <span class="comment">// （必填）通知支付接口（get）</span></span><br><span class="line">        params.put(<span class="string">"refundExt"</span>, <span class="string">""</span>);                                    <span class="comment">// （选填）退款擴展字段</span></span><br><span class="line">        params.put(<span class="string">"sign"</span>, sign(icbcmoConfig.getMd5Key(), params));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 转换成为请求参数 a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String queryStr = queryStr(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 组装接口地址 https://app.icbcmo.site/api/v1/order?a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String request = icbcmoProperties.getUrl() + <span class="string">"/api/v1/refund/initRefund?"</span> + queryStr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 请求接口</span></span><br><span class="line">        log.info(<span class="string">"IcbcmoService.query Request: \n"</span> + request);</span><br><span class="line">        String responseStr = Request.Post(request)</span><br><span class="line">                                    .execute()</span><br><span class="line">                                    .returnContent().toString();</span><br><span class="line">        log.info(<span class="string">"IcbcmoService.query Response: \n"</span> + responseStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 结果处理</span></span><br><span class="line">        JSONObject response = JSONObject.parseObject(responseStr);</span><br><span class="line">        <span class="comment">// 8.1 退款成功</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"200"</span>.equals(response.getString(<span class="string">"retCode"</span>)) &amp;&amp;</span><br><span class="line">            <span class="string">"Success"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"refundStatus"</span>))) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                refundFeign.success(refundId);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"退款成功，退款订单处理异常："</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.2 退款中，需要异步回调里面处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8.2 商户没有退款权限</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"200"</span>.equals(response.getString(<span class="string">"retCode"</span>)) &amp;&amp;</span><br><span class="line">            <span class="string">"Fail"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"refundStatus"</span>))) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"refundStatusDesc"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"Unknow Error"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="退款结果异步通知"><a href="#退款结果异步通知" class="headerlink" title="退款结果异步通知"></a>退款结果异步通知</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap8/chap8.html">https://app.icbcmo.site/gitbook/cn/chap8/chap8.html</a></p>
<h4 id="异步通知参数-1"><a href="#异步通知参数-1" class="headerlink" title="异步通知参数"></a>异步通知参数</h4><p><strong>1. 原始参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://dev.easybyte-hk.com/api/icbcmo/refund/notify&amp;channelRefundId=90000000000200000011704109187879&amp;channelTransId=4200001201202106174554738390&amp;icbcOrderId=011WE20210617175718736113949&amp;icbcRefundOrderId=RF20210617175801207146359&amp;merchantId=011900000000002&amp;merchantOrderId=20210617175715888215&amp;merchantRefundOrderId=20210617175801196939&amp;refundAmount=5&amp;refundCurrency=MOP&amp;refundRealAmount=4&amp;refundRealCurrency=CNY&amp;refundStatus=Success&amp;refundStatusDesc=%E6%88%90%E5%8A%9F&amp;sign=6d65b03c2ddd17622ff2c0a7c083d51b</span><br></pre></td></tr></table></figure>
<p><strong>2. 解析参数</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">channelRefundId=90000000000200000011704109187879, </span><br><span class="line">refundRealAmount=4, </span><br><span class="line">sign=6d65b03c2ddd17622ff2c0a7c083d51b, </span><br><span class="line">refundStatus=Success, </span><br><span class="line">merchantOrderId=20210617175715888215, </span><br><span class="line">icbcOrderId=011WE20210617175718736113949, </span><br><span class="line">icbcRefundOrderId=RF20210617175801207146359, </span><br><span class="line">refundRealCurrency=CNY, </span><br><span class="line">merchantId=011900000000002, </span><br><span class="line">refundStatusDesc=成功, </span><br><span class="line">merchantRefundOrderId=20210617175801196939, </span><br><span class="line">refundCurrency=MOP, </span><br><span class="line">channelTransId=4200001201202106174554738390, </span><br><span class="line">refundAmount=5</span><br></pre></td></tr></table></figure>
<h4 id="异步接收方法"><a href="#异步接收方法" class="headerlink" title="异步接收方法"></a>异步接收方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/refund/notify"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refundNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 解析回调参数</span></span><br><span class="line">    log.info(<span class="string">"ICBCMO 原始退款结果异步通知参数：&#123;&#125;&#123;&#125;&#123;&#125;"</span>, request.getRequestURL(), <span class="string">"&amp;"</span>, request.getQueryString());</span><br><span class="line">    Enumeration&lt;String&gt; names = request.getParameterNames();</span><br><span class="line">    Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">        String name = names.nextElement();</span><br><span class="line">        String value = request.getParameter(name);</span><br><span class="line">        params.put(name, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 处理支付回调 todo 应该异步处理</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">"ICBCMO 解析退款结果异步通知参数：&#123;&#125;"</span>, params);</span><br><span class="line">        icbcmoService.syncOrderNotiry(params);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"ICBCMO 处理退款结果异步通知异常：&#123;&#125;"</span>, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 返回success以確認完成通知成功（不管有没有处理成功）</span></span><br><span class="line">    <span class="meta">@Cleanup</span></span><br><span class="line">    PrintWriter printWriter = response.getWriter();</span><br><span class="line">    printWriter.write(<span class="string">"success"</span>);</span><br><span class="line">    printWriter.flush();</span><br><span class="line">    printWriter.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="异步处理方法"><a href="#异步处理方法" class="headerlink" title="异步处理方法"></a>异步处理方法</h4><h2 id="发起退款查询"><a href="#发起退款查询" class="headerlink" title="发起退款查询"></a>发起退款查询</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap9/chap9.html">https://app.icbcmo.site/gitbook/cn/chap9/chap9.html</a></p>
<h4 id="上送参数-1"><a href="#上送参数-1" class="headerlink" title="上送参数"></a>上送参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.175.59.29:10443/gwinternet/app-svc/api/v1/refund/getRefundResult?merchantId=011901200001005&amp;merchantRefundOrderId=20210610122701750629&amp;sign=ff6038170e7521b7cef9dbe5e59083f6</span><br></pre></td></tr></table></figure>
<h4 id="返回参数-1"><a href="#返回参数-1" class="headerlink" title="返回参数"></a>返回参数</h4><p><strong>1. 异常参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"1107"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"查無此退款記錄, The refund record is not found."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 线上 POS 支付退款正常参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210610122513062065"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001IC20210610122524825533543"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"ICBCOnlinePosOrder"</span>, </span><br><span class="line">        <span class="attr">"orderStatus"</span>: <span class="string">"Refund"</span>, </span><br><span class="line">        <span class="attr">"orderStatusDesc"</span>: <span class="string">""</span>, </span><br><span class="line">        <span class="attr">"cashCurrency"</span>: <span class="string">"81"</span>, </span><br><span class="line">        <span class="attr">"cashAmount"</span>: <span class="string">"1205"</span>, </span><br><span class="line">        <span class="attr">"totalRefundCount"</span>: <span class="string">"1"</span>, </span><br><span class="line">        <span class="attr">"refundList"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"merchantRefundOrderId"</span>: <span class="string">"20210610122701750629"</span>, </span><br><span class="line">                <span class="attr">"icbcRefundOrderId"</span>: <span class="string">"RF20210610122701149283870"</span>, </span><br><span class="line">                <span class="attr">"refundStatus"</span>: <span class="string">"Success"</span>, </span><br><span class="line">                <span class="attr">"refundCurrency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">                <span class="attr">"refundAmount"</span>: <span class="string">"1205"</span>, </span><br><span class="line">                <span class="attr">"refundRealCurrency"</span>: <span class="string">"81"</span>, </span><br><span class="line">                <span class="attr">"refundRealAmount"</span>: <span class="string">"1205"</span>, </span><br><span class="line">                <span class="attr">"refundSuccessTime"</span>: <span class="string">"2021-06-10 12:27:04"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"1cc9acdf69982c51524c2a1ec877facc"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上送方法-1"><a href="#上送方法-1" class="headerlink" title="上送方法"></a>上送方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RefundStatus <span class="title">getRefundResult</span><span class="params">(Long refundId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Refund refund = refundFeign.one(id(refundId), attr(Refund::getOrderId, Refund::getCode));</span><br><span class="line">        Order order = orderFeign.one(id(refund.getOrderId()), attr(Order::getMerchantId, Order::getPayEnum, Order::getPayAgent));</span><br><span class="line">        IcbcmoConfig icbcmoConfig = icbcmoConfig(order.getMerchantId(), order.getPayEnum());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 组装请求参数</span></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"merchantId"</span>, icbcmoConfig.getMerchantId());         <span class="comment">// （必填）商戶號</span></span><br><span class="line">        params.put(<span class="string">"icbcOrderId"</span>, <span class="string">""</span>);                                  <span class="comment">// （选填）ICBC訂單ID註: icbcOrderId, merchantOrderId: 2選1。處理次序為icbcOrderIdàmerchantOrderId</span></span><br><span class="line">        params.put(<span class="string">"merchantOrderId"</span>, order.getCode());                 <span class="comment">// （选填）商戶訂單ID 註: icbcOrderId, merchantOrderId: 2選1。處理次序為icbcOrderIdàmerchantOrderId</span></span><br><span class="line">        params.put(<span class="string">"channelTransId"</span>, <span class="string">""</span>);                               <span class="comment">// （选填）渠道方原交易訂單ID註</span></span><br><span class="line">        params.put(<span class="string">"merchantRefundOrderId"</span>, refund.getCode());          <span class="comment">// （选填）商戶退款訂單</span></span><br><span class="line">        params.put(<span class="string">"icbcRefundOrderId"</span>, <span class="string">""</span>);                            <span class="comment">// （选填）商戶退款訂單</span></span><br><span class="line">        params.put(<span class="string">"channelRefundId"</span>, <span class="string">""</span>);                              <span class="comment">// （选填）渠道方生成的退款交易流水號，僅退款成功返回</span></span><br><span class="line">        params.put(<span class="string">"sign"</span>, sign(icbcmoConfig.getMd5Key(), params));     <span class="comment">// （必填）簽名用於校驗參數是否被篡改</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 转换成为请求参数 a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String queryStr = queryStr(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 组装接口地址 https://app.icbcmo.site/api/v1/order?a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String request = icbcmoProperties.getUrl() + <span class="string">"/api/v1/refund/getRefundResult?"</span> + queryStr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 请求接口</span></span><br><span class="line">        log.info(<span class="string">"IcbcmoService.getRefundResult Request: \n"</span> + request);</span><br><span class="line">        String responseStr = Request.Get(request)</span><br><span class="line">                                    .execute()</span><br><span class="line">                                    .returnContent().toString();</span><br><span class="line">        log.info(<span class="string">"IcbcmoService.getRefundResult Response: \n"</span> + responseStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 结果处理</span></span><br><span class="line">        JSONObject response = JSONObject.parseObject(responseStr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"200"</span>.equals(response.getString(<span class="string">"retCode"</span>))) &#123;</span><br><span class="line">            <span class="comment">// 8.1 退款中（所以其它状态，都当作退款中）</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"!Refund"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                <span class="keyword">return</span> RefundStatus.PROCESSING;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 8.2 退款成功</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"Refund"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                <span class="keyword">return</span> RefundStatus.SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.3 其它异常（退款不存在之类的）</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, response.getString(<span class="string">"msg"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关闭订单"><a href="#关闭订单" class="headerlink" title="关闭订单"></a>关闭订单</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap10/chap10.html">https://app.icbcmo.site/gitbook/cn/chap10/chap10.html</a></p>
<h4 id="上送参数-2"><a href="#上送参数-2" class="headerlink" title="上送参数"></a>上送参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://202.175.59.29:10443/gwinternet/app-svc/api/v1/order/close?merchantId=011901200001005&amp;merchantOrderId=20210610170740444269&amp;sign=ddd3fd6b9085c36da9dc46e8547be54a</span><br></pre></td></tr></table></figure>
<h4 id="返回参数-2"><a href="#返回参数-2" class="headerlink" title="返回参数"></a>返回参数</h4><p><strong>1. 错误参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"code"</span>: <span class="string">"1095"</span>,</span><br><span class="line">  <span class="attr">"retCode"</span>: <span class="string">"500"</span>,</span><br><span class="line">  <span class="attr">"msg"</span>: <span class="string">"查無此訂單，請核實, Check this order, please verify"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 正确参数</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// ？？？没有发现这个返回</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"retCode"</span>: <span class="string">"200"</span>,</span><br><span class="line">  <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">    <span class="attr">"merchantId"</span>: <span class="string">"011901200001001"</span>,</span><br><span class="line">    <span class="attr">"merchantOrderId"</span>: <span class="string">"ICBC_AIO_20190710_233100"</span>,</span><br><span class="line">    <span class="attr">"icbcOrderId"</span>: <span class="string">"011AL20190710233158379876488"</span>,</span><br><span class="line">    <span class="attr">"orderStatus"</span>: <span class="string">"Success"</span>,</span><br><span class="line">    <span class="attr">"orderStatusDesc"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"errorCode"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"errorMessage"</span>: <span class="string">""</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sign"</span>: <span class="string">"4e349f7fa5ec47f5321ab967edc6bc8c"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 这个有返回</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210610170740444269"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001IC20210610174515370150881"</span>, </span><br><span class="line">        <span class="attr">"status"</span>: <span class="string">"Success"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"ea8b253df58e8accbab5dfdbe575d966"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="上送方法-2"><a href="#上送方法-2" class="headerlink" title="上送方法"></a>上送方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(IcbcmoConfig icbcmoConfig, String merchantOrderId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 4. 组装退款参数</span></span><br><span class="line">        Map&lt;String, String&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        params.put(<span class="string">"merchantId"</span>, icbcmoConfig.getMerchantId());         <span class="comment">// （必填）商戶號</span></span><br><span class="line">        params.put(<span class="string">"merchantOrderId"</span>, merchantOrderId);                 <span class="comment">// （选填）商戶訂單號 註: merchantOrderId, icbcOrderId: 2選1</span></span><br><span class="line">        params.put(<span class="string">"icbcOrderId"</span>, <span class="string">""</span>);                                  <span class="comment">// （选填）ICBC訂單號 註: merchantOrderId, icbcOrderId: 2選1</span></span><br><span class="line">        params.put(<span class="string">"sign"</span>, sign(icbcmoConfig.getMd5Key(), params));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 转换成为请求参数 a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String queryStr = queryStr(params);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 组装接口地址 https://app.icbcmo.site/api/v1/order?a=1&amp;b=2&amp;c=3&amp;sign=4</span></span><br><span class="line">        String request = icbcmoProperties.getUrl() + <span class="string">"/api/v1/order/close?"</span> + queryStr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 请求接口</span></span><br><span class="line">        log.info(<span class="string">"IcbcmoService.close Request: \n"</span> + request);</span><br><span class="line">        String responseStr = Request.Post(request)</span><br><span class="line">                                    .execute()</span><br><span class="line">                                    .returnContent().toString();</span><br><span class="line">        log.info(<span class="string">"IcbcmoService.close Response: \n"</span> + responseStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 结果处理</span></span><br><span class="line">        JSONObject response = JSONObject.parseObject(responseStr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"200"</span>.equals(response.getString(<span class="string">"retCode"</span>))) &#123;</span><br><span class="line">            <span class="comment">// 8.1 关闭失败</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"Success"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"关闭订单失败"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 8.2 关闭成功</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"Success"</span>.equals(response.getJSONObject(<span class="string">"returnObj"</span>).getString(<span class="string">"orderStatus"</span>))) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.3 订单不存在，或者其它异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"关闭订单失败"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="下载对账文件"><a href="#下载对账文件" class="headerlink" title="下载对账文件"></a>下载对账文件</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap11/chap11.html">https://app.icbcmo.site/gitbook/cn/chap11/chap11.html</a></p>
<h2 id="通用方法"><a href="#通用方法" class="headerlink" title="通用方法"></a>通用方法</h2><h4 id="将-Map-转换成为请求参数"><a href="#将-Map-转换成为请求参数" class="headerlink" title="将 Map 转换成为请求参数"></a>将 Map 转换成为请求参数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 将Map转换成为请求参数</span></span><br><span class="line"><span class="comment">* &#123;"a":1, "b": 2&#125; -&gt; a=2&amp;b=2</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">queryStr</span><span class="params">(Map&lt;String, String&gt; signMap)</span> </span>&#123;</span><br><span class="line">   List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;&gt;(signMap.keySet());</span><br><span class="line">   Collections.sort(keys);</span><br><span class="line"></span><br><span class="line">   StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">      String value = signMap.get(key);</span><br><span class="line">      <span class="keyword">if</span> (StringUtils.isEmpty(value)) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">            value = URLEncoder.encode(value, <span class="string">"utf-8"</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      sb.append(key).append(<span class="string">"="</span>).append(value).append(<span class="string">"&amp;"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (sb.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      sb.deleteCharAt(sb.length() - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   System.out.println(<span class="string">"dataStr: "</span> + sb);</span><br><span class="line">   <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="计算签名"><a href="#计算签名" class="headerlink" title="计算签名"></a>计算签名</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">sign</span><span class="params">(String privateKey, Map&lt;String, String&gt; signMap)</span> </span>&#123;</span><br><span class="line">   String dataStr = queryStr(signMap);</span><br><span class="line">   <span class="keyword">return</span> Md5Utils.getMD5((dataStr + privateKey).getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="渠道擴展字段"><a href="#渠道擴展字段" class="headerlink" title="渠道擴展字段"></a>渠道擴展字段</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 微信参数表</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">weixinChannelExt</span><span class="params">(IcbcmoPay icbcmoPay, String openId)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (icbcmoPay == <span class="keyword">null</span> || icbcmoPay.getWeixinChannelExt() == <span class="keyword">null</span> || StringUtils.isEmpty(openId)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ServiceException(BaseResultEnum.ERROR, <span class="string">"数据异常"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   JSONObject params = <span class="keyword">new</span> JSONObject();</span><br><span class="line">   params.put(<span class="string">"body"</span>, <span class="string">""</span>);                                             <span class="comment">// 訂單購物明細，非必填。如不填入則系統自動填入商家簡稱。</span></span><br><span class="line">   params.put(<span class="string">"custom_display_code"</span>, <span class="string">""</span>);                              <span class="comment">// 是否商家自建支付頁面或使用系統支付頁面。商家自建支付頁面: Y系統支付頁面: N (默認)</span></span><br><span class="line">   params.put(<span class="string">"wx_appid"</span>, icbcmoPay.getWeixinChannelExt().getAppId()); <span class="comment">// 商戶在微信開放平臺註冊生成的appid。渠道為微信APP和微信小程序時必填。</span></span><br><span class="line">   params.put(<span class="string">"openid"</span>, openId);                                       <span class="comment">// 商戶在微信開放平臺註冊生成的appid。渠道為微信APP和微信小程序時必填。</span></span><br><span class="line">   <span class="keyword">return</span> params.toJSONString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="响应数据-1"><a href="#响应数据-1" class="headerlink" title="响应数据"></a>响应数据</h2><h4 id="發起支付请求"><a href="#發起支付请求" class="headerlink" title="發起支付请求"></a>發起支付请求</h4><p><strong>1. 请求参数</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zhangqinghua$ curl https://app.icbcmo.site/api/v1/order?amount=7&amp;channel=WechatMiniApp&amp;channelExt=%7B%22custom_display_code%22%3A%22%22%2C%22wx_appid%22%3A%22wx47d7859ff4ec85c4%22%2C%22openid%22%3A%22ohGhc5MWsYW_zkB4j0C_zCDx93H0%22%2C%22body%22%3A%22%22%7D&amp;currency=MOP&amp;merchantId=011900000000002&amp;merchantOrderId=20210604155233849229&amp;merchantTid=00000011&amp;notifyUrl=https%3A%2F%2Fwww.baidu.com&amp;returnUrl=pages%2Findex%2Findex&amp;sign=722d3cfeae052f6d02bc1b0fa9af8648&amp;timeout=300</span><br></pre></td></tr></table></figure>
<p><strong>2. 异常响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"1094"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"訂單號重複, Duplicate order number"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011999010002500"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000001"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"WechatMiniApp"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"100000581"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001WE20210602105446369294200"</span>, </span><br><span class="line">        <span class="attr">"currency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"amount"</span>: <span class="string">"5"</span>, </span><br><span class="line">        <span class="attr">"respCode"</span>: <span class="string">"42"</span>, </span><br><span class="line">        <span class="attr">"respMsgDetail"</span>: <span class="string">"參數錯誤，請根據文檔上送參數[小程式尺幅需要填入參數openid]"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"970360aa375bdebc7e7ab2dccc68b719"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011999010002500"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000001"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"WechatMiniApp"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"10000058182137"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001WE20210602111424424911969"</span>, </span><br><span class="line">        <span class="attr">"currency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"amount"</span>: <span class="string">"5"</span>, </span><br><span class="line">        <span class="attr">"respCode"</span>: <span class="string">"32"</span>, </span><br><span class="line">        <span class="attr">"respMsgDetail"</span>: <span class="string">"生成預付單失敗，請聯繫機構檢查"</span>, </span><br><span class="line">        <span class="attr">"wxErrCode"</span>: <span class="string">"FAIL"</span>, </span><br><span class="line">        <span class="attr">"wxErrCodeDesc"</span>: <span class="string">"sub_mch_id与sub_appid不匹配"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"0477f49c3ab4645085c3455afce9c91e"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. 微信扫码支付响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"retCode"</span>:<span class="string">"200"</span>,</span><br><span class="line">   <span class="attr">"returnObj"</span>:</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="attr">"merchantId"</span>:<span class="string">"011901200001001"</span>,</span><br><span class="line">      <span class="attr">"merchantTid"</span>:<span class="string">"11"</span>,</span><br><span class="line">      <span class="attr">"channel"</span>:<span class="string">"WechatPayPC"</span>,</span><br><span class="line">      <span class="attr">"merchantOrderId"</span>:<span class="string">"ICBC_AIO_20190711_091944"</span>,</span><br><span class="line">      <span class="attr">"icbcOrderId"</span>:<span class="string">"011WE20190711091957823988639"</span>,</span><br><span class="line">      <span class="attr">"currency"</span>:<span class="string">"MOP"</span>,</span><br><span class="line">      <span class="attr">"amount"</span>:<span class="string">"100"</span>,</span><br><span class="line">      <span class="attr">"redirectUrl"</span>:<span class="string">"https://mobilepaytest.icbc.com.mo/api/payment/NativePayPage.aspx?orderno=90120000100100000011190711538371&amp;sign=3661b8d0975563e85dcc9df3ce94b065&amp;time=120"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"sign"</span>:<span class="string">"c5a7ec6aa5c57eb6b4fa0aa41a2bb26a"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. 微信小程序支付响应</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011900000000002"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000011"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"WechatMiniApp"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"10000058160843"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"011WE20210603183143021474642"</span>, </span><br><span class="line">        <span class="attr">"currency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"amount"</span>: <span class="string">"5"</span>, </span><br><span class="line">        <span class="attr">"respCode"</span>: <span class="string">"00"</span>, </span><br><span class="line">        <span class="attr">"respMsgDetail"</span>: <span class="string">"SUCCESS"</span>, </span><br><span class="line">        <span class="attr">"sign"</span>: <span class="string">"D1E5B79FF8569EFD5CF1BFF42481817C"</span>, </span><br><span class="line">        <span class="attr">"appId"</span>: <span class="string">"wx47d7859ff4ec85c4"</span>, </span><br><span class="line">        <span class="attr">"nonceStr"</span>: <span class="string">"BD686FD640BE98EFAAE0091FA301E613"</span>, </span><br><span class="line">        <span class="attr">"signType"</span>: <span class="string">"MD5"</span>, </span><br><span class="line">        <span class="attr">"timeStamp"</span>: <span class="string">"1622716302"</span>, </span><br><span class="line">        <span class="attr">"package"</span>: <span class="string">"prepay_id=wx031831441262294383aa020140228c0000"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"2f553aa3ab9e44c516d8172cd5c720a8"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5. POS 支付返回</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"200"</span>, </span><br><span class="line">    <span class="attr">"returnObj"</span>: &#123;</span><br><span class="line">        <span class="attr">"merchantId"</span>: <span class="string">"011901200001005"</span>, </span><br><span class="line">        <span class="attr">"merchantTid"</span>: <span class="string">"00000001"</span>, </span><br><span class="line">        <span class="attr">"channel"</span>: <span class="string">"ICBCOnlinePosOrder"</span>, </span><br><span class="line">        <span class="attr">"merchantOrderId"</span>: <span class="string">"20210607112944860991"</span>, </span><br><span class="line">        <span class="attr">"icbcOrderId"</span>: <span class="string">"001IC20210607145051758855978"</span>, </span><br><span class="line">        <span class="attr">"currency"</span>: <span class="string">"MOP"</span>, </span><br><span class="line">        <span class="attr">"amount"</span>: <span class="string">"6"</span>, </span><br><span class="line">        <span class="attr">"redirectUrl"</span>: <span class="string">"https://ebankpfovaopay4.dccnet.com.cn/servletxxxxx"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="attr">"sign"</span>: <span class="string">"7cc6461d3e6f92155f867790c4b40529"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="发起退款申请-1"><a href="#发起退款申请-1" class="headerlink" title="发起退款申请"></a>发起退款申请</h4><h4 id="退款结果异步通知-1"><a href="#退款结果异步通知-1" class="headerlink" title="退款结果异步通知"></a>退款结果异步通知</h4><h2 id="商户异常"><a href="#商户异常" class="headerlink" title="商户异常"></a>商户异常</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"9998"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"channel 請求參數不合法"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"1091"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"簽名信息有誤, Signature information is incorrect"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"1125"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"500"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"獲取商戶信息出現異常. query merchant is abnormal"</span></span><br><span class="line">&#125;</span><br><span class="line">// 商户号错误？？？？</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="string">"9999"</span>, </span><br><span class="line">    <span class="attr">"retCode"</span>: <span class="string">"400"</span>, </span><br><span class="line">    <span class="attr">"msg"</span>: <span class="string">"系統後台異常！, System background exception!"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="附：簽名測試接口"><a href="#附：簽名測試接口" class="headerlink" title="附：簽名測試接口"></a>附：簽名測試接口</h2><p>参考：<a href="https://app.icbcmo.site/gitbook/cn/chap13/chap13.html">https://app.icbcmo.site/gitbook/cn/chap13/chap13.html</a></p>
<p>該測試接口用於測試下單參數的簽名結果，把所有下單參數（排除 sign 字段）post 到這個接口，即會返回參與簽名的內容（已隱藏signKey）及簽名結果，用於商戶自行校驗簽名方法及排查簽名錯誤原因。</p>
<p>請求URL: /api/v1/test/sign 請求方式: POST</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210608180002.png" alt=""></p>
<h2 id="附：测试卡号和查询短信验证码"><a href="#附：测试卡号和查询短信验证码" class="headerlink" title="附：测试卡号和查询短信验证码"></a>附：测试卡号和查询短信验证码</h2><p>5440163901773005<br>5305063800002981<br>5428952600066083<br>5428952600066711<br>5440163900896286<br>5305066800004683<br>4574108900102574<br>4918872100062525<br>4377652000074711<br>4574108900117879<br>6250171800008073<br>6250191800004591<br>6250181800006308<br>6250181800016455<br>6250181800041479</p>
<p>访问 <a href="https://gwinternet.icbcmo.site/sms-inq-svc/v1/inqByCardNo?cardNo=4377651200336011">https://gwinternet.icbcmo.site/sms-inq-svc/v1/inqByCardNo?cardNo=4377651200336011</a> 按卡号查询短信验证码 (把路径中 cardNo 后的值替换成测试的卡号)</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#发起支付请求"><span class="toc-number">1.</span> <span class="toc-text">发起支付请求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#微信小程序支付"><span class="toc-number">1.0.1.</span> <span class="toc-text">微信小程序支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#信用卡支付"><span class="toc-number">1.0.2.</span> <span class="toc-text">信用卡支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#支付请求"><span class="toc-number">1.0.3.</span> <span class="toc-text">支付请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#支付结果异步通知"><span class="toc-number">2.</span> <span class="toc-text">支付结果异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知参数"><span class="toc-number">2.0.1.</span> <span class="toc-text">异步通知参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知接收方法"><span class="toc-number">2.0.2.</span> <span class="toc-text">异步通知接收方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知处理方法"><span class="toc-number">2.0.3.</span> <span class="toc-text">异步通知处理方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起主动查询"><span class="toc-number">3.</span> <span class="toc-text">发起主动查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#请求参数"><span class="toc-number">3.0.1.</span> <span class="toc-text">请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#响应数据"><span class="toc-number">3.0.2.</span> <span class="toc-text">响应数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#请求方法"><span class="toc-number">3.0.3.</span> <span class="toc-text">请求方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起退款申请"><span class="toc-number">4.</span> <span class="toc-text">发起退款申请</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数"><span class="toc-number">4.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数"><span class="toc-number">4.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法"><span class="toc-number">4.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#退款结果异步通知"><span class="toc-number">5.</span> <span class="toc-text">退款结果异步通知</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#异步通知参数-1"><span class="toc-number">5.0.1.</span> <span class="toc-text">异步通知参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步接收方法"><span class="toc-number">5.0.2.</span> <span class="toc-text">异步接收方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步处理方法"><span class="toc-number">5.0.3.</span> <span class="toc-text">异步处理方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#发起退款查询"><span class="toc-number">6.</span> <span class="toc-text">发起退款查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数-1"><span class="toc-number">6.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数-1"><span class="toc-number">6.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法-1"><span class="toc-number">6.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关闭订单"><span class="toc-number">7.</span> <span class="toc-text">关闭订单</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上送参数-2"><span class="toc-number">7.0.1.</span> <span class="toc-text">上送参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#返回参数-2"><span class="toc-number">7.0.2.</span> <span class="toc-text">返回参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#上送方法-2"><span class="toc-number">7.0.3.</span> <span class="toc-text">上送方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载对账文件"><span class="toc-number">8.</span> <span class="toc-text">下载对账文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通用方法"><span class="toc-number">9.</span> <span class="toc-text">通用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#将-Map-转换成为请求参数"><span class="toc-number">9.0.1.</span> <span class="toc-text">将 Map 转换成为请求参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计算签名"><span class="toc-number">9.0.2.</span> <span class="toc-text">计算签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#渠道擴展字段"><span class="toc-number">9.0.3.</span> <span class="toc-text">渠道擴展字段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#响应数据-1"><span class="toc-number">10.</span> <span class="toc-text">响应数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#發起支付请求"><span class="toc-number">10.0.1.</span> <span class="toc-text">發起支付请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#发起退款申请-1"><span class="toc-number">10.0.2.</span> <span class="toc-text">发起退款申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#退款结果异步通知-1"><span class="toc-number">10.0.3.</span> <span class="toc-text">退款结果异步通知</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#商户异常"><span class="toc-number">11.</span> <span class="toc-text">商户异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附：簽名測試接口"><span class="toc-number">12.</span> <span class="toc-text">附：簽名測試接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附：测试卡号和查询短信验证码"><span class="toc-number">13.</span> <span class="toc-text">附：测试卡号和查询短信验证码</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&text=聚合支付 Icbcmo"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&is_video=false&description=聚合支付 Icbcmo"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=聚合支付 Icbcmo&body=Check out this article: http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&title=聚合支付 Icbcmo"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/04/27/架构设计/支付开发/聚合支付 Icbcmo/&name=聚合支付 Icbcmo&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/archives/">Articles</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/search/">Search</a></li>
        
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
