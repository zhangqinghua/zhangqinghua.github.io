<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="正常流程1. 依赖和业务代码pom.xml 依赖： 1234567891011121314151617181920&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;         xmlns:xsi=&quot;http://www.w3.org/2001/XML">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot 事务源码">
<meta property="og:url" content="http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="正常流程1. 依赖和业务代码pom.xml 依赖： 1234567891011121314151617181920&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;         xmlns:xsi=&quot;http://www.w3.org/2001/XML">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609231304.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609232233.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609232915.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233406.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233535.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233916.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234150.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234524.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234846.png">
<meta property="og:updated_time" content="2021-06-22T01:55:01.505Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpringBoot 事务源码">
<meta name="twitter:description" content="正常流程1. 依赖和业务代码pom.xml 依赖： 1234567891011121314151617181920&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;         xmlns:xsi=&quot;http://www.w3.org/2001/XML">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609231304.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>SpringBoot 事务源码</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/06/09/后端开发/Redis 手册/Redis 常见问题/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/06/09/架构设计/Git 手册/Git 分支策略/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&text=SpringBoot 事务源码"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&is_video=false&description=SpringBoot 事务源码"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SpringBoot 事务源码&body=Check out this article: http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&name=SpringBoot 事务源码&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#正常流程"><span class="toc-number">1.</span> <span class="toc-text">正常流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-依赖和业务代码"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 依赖和业务代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ReflectiveMethodInvocation-动态代理转入事务拦截器"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. ReflectiveMethodInvocation 动态代理转入事务拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-TransactionInterceptor-事务拦截器"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. TransactionInterceptor 事务拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-TransactionAspectSupport-事务切面"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. TransactionAspectSupport 事务切面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：determineTransactionManager-返回一个事务管理器"><span class="toc-number">1.0.5.</span> <span class="toc-text">附：determineTransactionManager 返回一个事务管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：asPlatformTransactionManager-强转成为PlatformTransactionManager事务管理器"><span class="toc-number">1.0.6.</span> <span class="toc-text">附：asPlatformTransactionManager 强转成为PlatformTransactionManager事务管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：createTransactionIfNecessary-创建一个事务"><span class="toc-number">1.0.7.</span> <span class="toc-text">附：createTransactionIfNecessary 创建一个事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：tm-getTransaction-获取一个事务"><span class="toc-number">1.0.8.</span> <span class="toc-text">附：tm.getTransaction 获取一个事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：startTransaction"><span class="toc-number">1.0.9.</span> <span class="toc-text">附：startTransaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：DataSourceTransactionManager-doBegin"><span class="toc-number">1.0.10.</span> <span class="toc-text">附：DataSourceTransactionManager.doBegin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：DataSourceTransactionManager-prepareTransactionalConnection"><span class="toc-number">1.0.11.</span> <span class="toc-text">附：DataSourceTransactionManager.prepareTransactionalConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：TransactionSynchronizationManager-bindResource-将连接绑定在当前线程上"><span class="toc-number">1.0.12.</span> <span class="toc-text">附：TransactionSynchronizationManager.bindResource 将连接绑定在当前线程上</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SpringBoot 事务源码
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Hexo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-06-09T00:00:00.000Z" itemprop="datePublished">2021-06-09</time>
        
        (Updated: <time datetime="2021-06-22T01:55:01.505Z" itemprop="dateModified">2021-06-22</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/后端开发/">后端开发</a> › <a class="category-link" href="/categories/后端开发/SpringBoot-源码/">SpringBoot 源码</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="正常流程"><a href="#正常流程" class="headerlink" title="正常流程"></a>正常流程</h2><h4 id="1-依赖和业务代码"><a href="#1-依赖和业务代码" class="headerlink" title="1. 依赖和业务代码"></a>1. 依赖和业务代码</h4><p>pom.xml 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.13.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.zhangqinghua.learn<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-learning<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>springboot-sourcecode<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>业务代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/demo"</span>)</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">demo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"demo..."</span>);</span><br><span class="line">        <span class="keyword">long</span> id = System.currentTimeMillis();</span><br><span class="line">        String token = <span class="string">"token"</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">10000</span>);</span><br><span class="line">        String sql = <span class="string">"insert into sys_user_token (user_id,token) values ("</span> + id + <span class="string">",'"</span> + token + <span class="string">"')"</span>;</span><br><span class="line">        jdbcTemplate.update(sql);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HelloWorld"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行链：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609231304.png" alt=""></p>
<h4 id="2-ReflectiveMethodInvocation-动态代理转入事务拦截器"><a href="#2-ReflectiveMethodInvocation-动态代理转入事务拦截器" class="headerlink" title="2. ReflectiveMethodInvocation 动态代理转入事务拦截器"></a>2. ReflectiveMethodInvocation 动态代理转入事务拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">   <span class="comment">// 2. 第二次进来，执行业务方法</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.currentInterceptorIndex == <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.invokeJoinpoint();</span><br><span class="line">   &#125; </span><br><span class="line">   <span class="comment">// 1. 第一次进来，被@Transactional注解修饰，执行事务逻辑</span></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      Object interceptorOrInterceptionAdvice = <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="keyword">this</span>.currentInterceptorIndex);</span><br><span class="line">      <span class="comment">// 1.1 其它注解类型</span></span><br><span class="line">      <span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">            InterceptorAndDynamicMethodMatcher dm = (InterceptorAndDynamicMethodMatcher)interceptorOrInterceptionAdvice;</span><br><span class="line">            Class&lt;?&gt; targetClass = <span class="keyword">this</span>.targetClass != <span class="keyword">null</span> ? <span class="keyword">this</span>.targetClass : <span class="keyword">this</span>.method.getDeclaringClass();</span><br><span class="line">            <span class="keyword">return</span> dm.methodMatcher.matches(<span class="keyword">this</span>.method, targetClass, <span class="keyword">this</span>.arguments) ? dm.interceptor.invoke(<span class="keyword">this</span>) : <span class="keyword">this</span>.proceed();</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="comment">// 1.2 @Transactional注解类型</span></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((MethodInterceptor)interceptorOrInterceptionAdvice).invoke(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-TransactionInterceptor-事务拦截器"><a href="#3-TransactionInterceptor-事务拦截器" class="headerlink" title="3. TransactionInterceptor 事务拦截器"></a>3. TransactionInterceptor 事务拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2. 准备执行事务逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">   <span class="comment">// org.zhangqinghua.transactional.api.TestController</span></span><br><span class="line">   Class&lt;?&gt; targetClass = (invocation.getThis() != <span class="keyword">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// param1: public java.lang.String org.zhangqinghua.transactional.api.TestController.demo()</span></span><br><span class="line">   <span class="comment">// param2: org.zhangqinghua.transactional.api.TestController</span></span><br><span class="line">   <span class="comment">// param3: unknow</span></span><br><span class="line">   <span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, invocation::proceed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-TransactionAspectSupport-事务切面"><a href="#4-TransactionAspectSupport-事务切面" class="headerlink" title="4. TransactionAspectSupport 事务切面"></a>4. TransactionAspectSupport 事务切面</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * General delegate for around-advice-based subclasses, delegating to several other template</span></span><br><span class="line"><span class="comment"> * methods on this class. Able to handle &#123;<span class="doctag">@link</span> CallbackPreferringPlatformTransactionManager&#125;</span></span><br><span class="line"><span class="comment"> * as well as regular &#123;<span class="doctag">@link</span> PlatformTransactionManager&#125; implementations and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> ReactiveTransactionManager&#125; implementations for reactive return types.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method the Method being invoked</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> targetClass the target class that we're invoking the method on</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invocation the callback to use for proceeding with the target invocation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the return value of the method, if any</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable propagated from the target invocation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">invokeWithinTransaction</span><span class="params">(Method method, @Nullable Class&lt;?&gt; targetClass,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 1. 不知道是什么东西 If the transaction attribute is null, the method is non-transactional.</span></span><br><span class="line">   TransactionAttributeSource tas = getTransactionAttributeSource();</span><br><span class="line">   <span class="comment">// 2. 应该是事务传播类型、事务隔离 PROPAGATION_REQUIRED,ISOLATION_DEFAULT</span></span><br><span class="line">   <span class="keyword">final</span> TransactionAttribute txAttr = (tas != <span class="keyword">null</span> ? tas.getTransactionAttribute(method, targetClass) : <span class="keyword">null</span>);</span><br><span class="line">   <span class="comment">// 3. 决定使用哪个事务管理器？</span></span><br><span class="line">   <span class="keyword">final</span> TransactionManager tm = determineTransactionManager(txAttr);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4. 这里应该是响应式事务处理，现在没有用到</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.reactiveAdapterRegistry != <span class="keyword">null</span> &amp;&amp; tm <span class="keyword">instanceof</span> ReactiveTransactionManager) &#123;</span><br><span class="line">      ReactiveTransactionSupport txSupport = <span class="keyword">this</span>.transactionSupportCache.computeIfAbsent(method, key -&gt; &#123;</span><br><span class="line">         <span class="keyword">if</span> (KotlinDetector.isKotlinType(method.getDeclaringClass()) &amp;&amp; KotlinDelegate.isSuspend(method)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TransactionUsageException(</span><br><span class="line">                  <span class="string">"Unsupported annotated transaction on suspending function detected: "</span> + method +</span><br><span class="line">                  <span class="string">". Use TransactionalOperator.transactional extensions instead."</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         ReactiveAdapter adapter = <span class="keyword">this</span>.reactiveAdapterRegistry.getAdapter(method.getReturnType());</span><br><span class="line">         <span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot apply reactive transaction to non-reactive return type: "</span> +</span><br><span class="line">                  method.getReturnType());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> ReactiveTransactionSupport(adapter);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> txSupport.invokeWithinTransaction(</span><br><span class="line">            method, targetClass, invocation, txAttr, (ReactiveTransactionManager) tm);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 5. 这里应该是跟数据源有关了，debug看到ptm.dataSource="HikariDataSource (HikariPool-1)"</span></span><br><span class="line">   PlatformTransactionManager ptm = asPlatformTransactionManager(tm);</span><br><span class="line">   <span class="comment">// 6. 这里应该是切入点 org.zhangqinghua.transactional.api.TestController.demo</span></span><br><span class="line">   <span class="keyword">final</span> String joinpointIdentification = methodIdentification(method, targetClass, txAttr);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 7. 事务逻辑</span></span><br><span class="line">   <span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || !(ptm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">      <span class="comment">// 7.1 创建一个事务 Standard transaction demarcation with getTransaction and commit/rollback calls.</span></span><br><span class="line">      TransactionInfo txInfo = createTransactionIfNecessary(ptm, txAttr, joinpointIdentification);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 7.2 执行业务逻辑，retVal是返回值：HelloWorld</span></span><br><span class="line">      Object retVal;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// This is an around advice: Invoke the next interceptor in the chain.</span></span><br><span class="line">         <span class="comment">// This will normally result in a target object being invoked.</span></span><br><span class="line">         <span class="comment">// 这里再回到 ReflectiveMethodInvocation.proceed执行业务方法</span></span><br><span class="line">         retVal = invocation.proceedWithInvocation();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 7.3 业务处理有异常，需要处理（回滚？）</span></span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">         <span class="comment">// target invocation exception</span></span><br><span class="line">         completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 7.4 清理事务</span></span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         cleanupTransactionInfo(txInfo);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 7.5 返回结果处理（不知道有什么用）</span></span><br><span class="line">      <span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;</span><br><span class="line">         <span class="comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span><br><span class="line">         TransactionStatus status = txInfo.getTransactionStatus();</span><br><span class="line">         <span class="keyword">if</span> (status != <span class="keyword">null</span> &amp;&amp; txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 7.6 字面意思是等返回值返回以后再提交事务</span></span><br><span class="line">      commitTransactionAfterReturning(txInfo);</span><br><span class="line">      <span class="keyword">return</span> retVal;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 8. 这里应该是跟事务无关的，没有执行到</span></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      Object result;</span><br><span class="line">      <span class="keyword">final</span> ThrowableHolder throwableHolder = <span class="keyword">new</span> ThrowableHolder();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// It's a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         result = ((CallbackPreferringPlatformTransactionManager) ptm).execute(txAttr, status -&gt; &#123;</span><br><span class="line">            TransactionInfo txInfo = prepareTransactionInfo(ptm, txAttr, joinpointIdentification, status);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">               Object retVal = invocation.proceedWithInvocation();</span><br><span class="line">               <span class="keyword">if</span> (retVal != <span class="keyword">null</span> &amp;&amp; vavrPresent &amp;&amp; VavrDelegate.isVavrTry(retVal)) &#123;</span><br><span class="line">                  <span class="comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span></span><br><span class="line">                  retVal = VavrDelegate.evaluateTryFailure(retVal, txAttr, status);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> retVal;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">               <span class="keyword">if</span> (txAttr.rollbackOn(ex)) &#123;</span><br><span class="line">                  <span class="comment">// A RuntimeException: will lead to a rollback.</span></span><br><span class="line">                  <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                     <span class="keyword">throw</span> (RuntimeException) ex;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> ThrowableHolderException(ex);</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// A normal return value: will lead to a commit.</span></span><br><span class="line">                  throwableHolder.throwable = ex;</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">               cleanupTransactionInfo(txInfo);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ThrowableHolderException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> ex.getCause();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (TransactionSystemException ex2) &#123;</span><br><span class="line">         <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"Application exception overridden by commit exception"</span>, throwableHolder.throwable);</span><br><span class="line">            ex2.initApplicationException(throwableHolder.throwable);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">throw</span> ex2;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex2) &#123;</span><br><span class="line">         <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"Application exception overridden by commit exception"</span>, throwableHolder.throwable);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">throw</span> ex2;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check result state: It might indicate a Throwable to rethrow.</span></span><br><span class="line">      <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> throwableHolder.throwable;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：determineTransactionManager-返回一个事务管理器"><a href="#附：determineTransactionManager-返回一个事务管理器" class="headerlink" title="附：determineTransactionManager 返回一个事务管理器"></a>附：determineTransactionManager 返回一个事务管理器</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609232233.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine the specific transaction manager to use for the given transaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TransactionManager <span class="title">determineTransactionManager</span><span class="params">(@Nullable TransactionAttribute txAttr)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 1. （略过）Do not attempt to lookup tx manager if no tx attributes are set</span></span><br><span class="line">   <span class="keyword">if</span> (txAttr == <span class="keyword">null</span> || <span class="keyword">this</span>.beanFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> getTransactionManager();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. （略过）选取指定的事务管理器</span></span><br><span class="line">   String qualifier = txAttr.getQualifier();</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasText(qualifier)) &#123;</span><br><span class="line">      <span class="keyword">return</span> determineQualifiedTransactionManager(<span class="keyword">this</span>.beanFactory, qualifier);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 3. （略过）选取指定的事务管理器</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.transactionManagerBeanName)) &#123;</span><br><span class="line">      <span class="keyword">return</span> determineQualifiedTransactionManager(<span class="keyword">this</span>.beanFactory, <span class="keyword">this</span>.transactionManagerBeanName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 4. （执行）返回当前的事务管理器</span></span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      TransactionManager defaultTransactionManager = getTransactionManager();</span><br><span class="line">      <span class="comment">// 4.1 （略过）重新生成一个事务管理器</span></span><br><span class="line">      <span class="keyword">if</span> (defaultTransactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">         defaultTransactionManager = <span class="keyword">this</span>.transactionManagerCache.get(DEFAULT_TRANSACTION_MANAGER_KEY);</span><br><span class="line">         <span class="keyword">if</span> (defaultTransactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            defaultTransactionManager = <span class="keyword">this</span>.beanFactory.getBean(TransactionManager.class);</span><br><span class="line">            <span class="keyword">this</span>.transactionManagerCache.putIfAbsent(</span><br><span class="line">                  DEFAULT_TRANSACTION_MANAGER_KEY, defaultTransactionManager);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> defaultTransactionManager;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：asPlatformTransactionManager-强转成为PlatformTransactionManager事务管理器"><a href="#附：asPlatformTransactionManager-强转成为PlatformTransactionManager事务管理器" class="headerlink" title="附：asPlatformTransactionManager 强转成为PlatformTransactionManager事务管理器"></a>附：asPlatformTransactionManager 强转成为PlatformTransactionManager事务管理器</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609232915.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> PlatformTransactionManager <span class="title">asPlatformTransactionManager</span><span class="params">(@Nullable Object transactionManager)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 1. 直接强转返回了</span></span><br><span class="line">   <span class="keyword">if</span> (transactionManager == <span class="keyword">null</span> || transactionManager <span class="keyword">instanceof</span> PlatformTransactionManager) &#123;</span><br><span class="line">      <span class="keyword">return</span> (PlatformTransactionManager) transactionManager;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            <span class="string">"Specified transaction manager is not a PlatformTransactionManager: "</span> + transactionManager);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：createTransactionIfNecessary-创建一个事务"><a href="#附：createTransactionIfNecessary-创建一个事务" class="headerlink" title="附：createTransactionIfNecessary 创建一个事务"></a>附：createTransactionIfNecessary 创建一个事务</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233406.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a transaction if necessary based on the given TransactionAttribute.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Allows callers to perform custom TransactionAttribute lookups through</span></span><br><span class="line"><span class="comment"> * the TransactionAttributeSource.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> txAttr the TransactionAttribute (may be &#123;<span class="doctag">@code</span> null&#125;)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> joinpointIdentification the fully qualified method name</span></span><br><span class="line"><span class="comment"> * (used for monitoring and logging purposes)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a TransactionInfo object, whether or not a transaction was created.</span></span><br><span class="line"><span class="comment"> * The &#123;<span class="doctag">@code</span> hasTransaction()&#125; method on TransactionInfo can be used to</span></span><br><span class="line"><span class="comment"> * tell if there was a transaction created.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getTransactionAttributeSource()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TransactionInfo <span class="title">createTransactionIfNecessary</span><span class="params">(@Nullable PlatformTransactionManager tm,</span></span></span><br><span class="line"><span class="function"><span class="params">      @Nullable TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 1. 没有特别指定的话，使用方法名作为事务名称 If no name specified, apply method identification as transaction name.</span></span><br><span class="line">   <span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; txAttr.getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">      txAttr = <span class="keyword">new</span> DelegatingTransactionAttribute(txAttr) &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> joinpointIdentification;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 从事务管理器中创建一个新的事务</span></span><br><span class="line">   TransactionStatus status = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (tm != <span class="keyword">null</span>) &#123;</span><br><span class="line">         status = tm.getTransaction(txAttr);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Skipping transactional joinpoint ["</span> + joinpointIdentification +</span><br><span class="line">                  <span class="string">"] because no transaction manager has been configured"</span>);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：tm-getTransaction-获取一个事务"><a href="#附：tm-getTransaction-获取一个事务" class="headerlink" title="附：tm.getTransaction 获取一个事务"></a>附：tm.getTransaction 获取一个事务</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233535.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This implementation handles propagation behavior. Delegates to</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> doGetTransaction&#125;, &#123;<span class="doctag">@code</span> isExistingTransaction&#125;</span></span><br><span class="line"><span class="comment"> * and &#123;<span class="doctag">@code</span> doBegin&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doGetTransaction</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #isExistingTransaction</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #doBegin</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> TransactionStatus <span class="title">getTransaction</span><span class="params">(@Nullable TransactionDefinition definition)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 1. （略过）Use defaults if no transaction definition given.</span></span><br><span class="line">   TransactionDefinition def = (definition != <span class="keyword">null</span> ? definition : TransactionDefinition.withDefaults());</span><br><span class="line"></span><br><span class="line">   Object transaction = doGetTransaction();</span><br><span class="line">   <span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. （略过）返回一个已经存在的事务</span></span><br><span class="line">   <span class="keyword">if</span> (isExistingTransaction(transaction)) &#123;</span><br><span class="line">      <span class="comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></span><br><span class="line">      <span class="keyword">return</span> handleExistingTransaction(def, transaction, debugEnabled);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. （略过）校验之类的 Check definition settings for new transaction.</span></span><br><span class="line">   <span class="keyword">if</span> (def.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InvalidTimeoutException(<span class="string">"Invalid transaction timeout"</span>, def.getTimeout());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 4. （略过）No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span></span><br><span class="line">   <span class="keyword">if</span> (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">            <span class="string">"No existing transaction found for transaction marked with propagation 'mandatory'"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 5. （执行）开启一个事务，并返回</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">         def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">         def.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">      SuspendedResourcesHolder suspendedResources = suspend(<span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Creating new transaction with name ["</span> + def.getName() + <span class="string">"]: "</span> + def);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> startTransaction(def, transaction, debugEnabled, suspendedResources);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (RuntimeException | Error ex) &#123;</span><br><span class="line">         resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line">         <span class="keyword">throw</span> ex;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Create "empty" transaction: no actual transaction, but potentially synchronization.</span></span><br><span class="line">      <span class="keyword">if</span> (def.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">         logger.warn(<span class="string">"Custom isolation level specified but no actual transaction initiated; "</span> +</span><br><span class="line">               <span class="string">"isolation level will effectively be ignored: "</span> + def);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">      <span class="keyword">return</span> prepareTransactionStatus(def, <span class="keyword">null</span>, <span class="keyword">true</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：startTransaction"><a href="#附：startTransaction" class="headerlink" title="附：startTransaction"></a>附：startTransaction</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609233916.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Start a new transaction.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> TransactionStatus <span class="title">startTransaction</span><span class="params">(TransactionDefinition definition, Object transaction,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">boolean</span> debugEnabled, @Nullable SuspendedResourcesHolder suspendedResources)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 1. true</span></span><br><span class="line">   <span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">   <span class="comment">// 2. 生成一个事务</span></span><br><span class="line">   DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">         definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">   <span class="comment">// 3. 开始是一个事务</span></span><br><span class="line">   doBegin(transaction, definition);</span><br><span class="line">   prepareSynchronization(status, definition);</span><br><span class="line">   <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：DataSourceTransactionManager-doBegin"><a href="#附：DataSourceTransactionManager-doBegin" class="headerlink" title="附：DataSourceTransactionManager.doBegin"></a>附：DataSourceTransactionManager.doBegin</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234150.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBegin</span><span class="params">(Object transaction, TransactionDefinition definition)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 1. 不知道干嘛用的，强转吧</span></span><br><span class="line">   DataSourceTransactionManager.DataSourceTransactionObject txObject = (DataSourceTransactionManager.DataSourceTransactionObject)transaction;</span><br><span class="line">   Connection con = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 2. （执行）从数据源获取一个连接，并设置在当前事务的ConnectionHolder上</span></span><br><span class="line">      <span class="keyword">if</span> (!txObject.hasConnectionHolder() || txObject.getConnectionHolder().isSynchronizedWithTransaction()) &#123;</span><br><span class="line">            Connection newCon = <span class="keyword">this</span>.obtainDataSource().getConnection();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">               <span class="keyword">this</span>.logger.debug(<span class="string">"Acquired Connection ["</span> + newCon + <span class="string">"] for JDBC transaction"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            txObject.setConnectionHolder(<span class="keyword">new</span> ConnectionHolder(newCon), <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3. 给这个连接设置一下属性</span></span><br><span class="line">      txObject.getConnectionHolder().setSynchronizedWithTransaction(<span class="keyword">true</span>);</span><br><span class="line">      con = txObject.getConnectionHolder().getConnection();</span><br><span class="line">      Integer previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition);</span><br><span class="line">      txObject.setPreviousIsolationLevel(previousIsolationLevel);</span><br><span class="line">      txObject.setReadOnly(definition.isReadOnly());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 4. 禁用自动提交（这样子事务才能起作用）</span></span><br><span class="line">      <span class="keyword">if</span> (con.getAutoCommit()) &#123;</span><br><span class="line">            txObject.setMustRestoreAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">               <span class="keyword">this</span>.logger.debug(<span class="string">"Switching JDBC Connection ["</span> + con + <span class="string">"] to manual commit"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            con.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.prepareTransactionalConnection(con, definition);</span><br><span class="line">      txObject.getConnectionHolder().setTransactionActive(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">int</span> timeout = <span class="keyword">this</span>.determineTimeout(definition);</span><br><span class="line">      <span class="keyword">if</span> (timeout != -<span class="number">1</span>) &#123;</span><br><span class="line">            txObject.getConnectionHolder().setTimeoutInSeconds(timeout);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 5. 将这个链接绑定在当前线程上（好像是）</span></span><br><span class="line">      <span class="keyword">if</span> (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">            TransactionSynchronizationManager.bindResource(<span class="keyword">this</span>.obtainDataSource(), txObject.getConnectionHolder());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">      <span class="keyword">if</span> (txObject.isNewConnectionHolder()) &#123;</span><br><span class="line">            DataSourceUtils.releaseConnection(con, <span class="keyword">this</span>.obtainDataSource());</span><br><span class="line">            txObject.setConnectionHolder((ConnectionHolder)<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> CannotCreateTransactionException(<span class="string">"Could not open JDBC Connection for transaction"</span>, var7);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：DataSourceTransactionManager-prepareTransactionalConnection"><a href="#附：DataSourceTransactionManager-prepareTransactionalConnection" class="headerlink" title="附：DataSourceTransactionManager.prepareTransactionalConnection"></a>附：DataSourceTransactionManager.prepareTransactionalConnection</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234524.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareTransactionalConnection</span><span class="params">(Connection con, TransactionDefinition definition)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">   <span class="comment">// 没有执行到，我靠</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.isEnforceReadOnly() &amp;&amp; definition.isReadOnly()) &#123;</span><br><span class="line">      Statement stmt = con.createStatement();</span><br><span class="line">      Throwable var4 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">            stmt.executeUpdate(<span class="string">"SET TRANSACTION READ ONLY"</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable var13) &#123;</span><br><span class="line">            var4 = var13;</span><br><span class="line">            <span class="keyword">throw</span> var13;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stmt != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (var4 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                        stmt.close();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">                        var4.addSuppressed(var12);</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  stmt.close();</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="附：TransactionSynchronizationManager-bindResource-将连接绑定在当前线程上"><a href="#附：TransactionSynchronizationManager-bindResource-将连接绑定在当前线程上" class="headerlink" title="附：TransactionSynchronizationManager.bindResource 将连接绑定在当前线程上"></a>附：TransactionSynchronizationManager.bindResource 将连接绑定在当前线程上</h4><p><img src="https://cdn.jsdelivr.net/gh/zhangqinghua/hexo_image/20210609234846.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; resources = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"Transactional resources"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Bind the given resource for the given key to the current thread.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key the key to bind the value to (usually the resource factory)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value the value to bind (usually the active resource object)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException if there is already a value bound to the thread</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ResourceTransactionManager#getResourceFactory()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bindResource</span><span class="params">(Object key, Object value)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">   <span class="comment">// 1. 就是上面那个key</span></span><br><span class="line">   Object actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(key);</span><br><span class="line">   Assert.notNull(value, <span class="string">"Value must not be null"</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 2. 不知道干嘛用的</span></span><br><span class="line">   Map&lt;Object, Object&gt; map = resources.get();</span><br><span class="line">   <span class="comment">// set ThreadLocal Map if none found</span></span><br><span class="line">   <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">      map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      resources.set(map);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 3. null key应该就是连接池了，value是连接</span></span><br><span class="line">   Object oldValue = map.put(actualKey, value);</span><br><span class="line">   <span class="comment">// 4. 没有执行到 Transparently suppress a ResourceHolder that was marked as void...</span></span><br><span class="line">   <span class="keyword">if</span> (oldValue <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) oldValue).isVoid()) &#123;</span><br><span class="line">      oldValue = <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 5. 没有执行到</span></span><br><span class="line">   <span class="keyword">if</span> (oldValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already value ["</span> + oldValue + <span class="string">"] for key ["</span> +</span><br><span class="line">            actualKey + <span class="string">"] bound to thread ["</span> + Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 6. 没有执行到</span></span><br><span class="line">   <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">      logger.trace(<span class="string">"Bound value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] to thread ["</span> +</span><br><span class="line">            Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#正常流程"><span class="toc-number">1.</span> <span class="toc-text">正常流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-依赖和业务代码"><span class="toc-number">1.0.1.</span> <span class="toc-text">1. 依赖和业务代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-ReflectiveMethodInvocation-动态代理转入事务拦截器"><span class="toc-number">1.0.2.</span> <span class="toc-text">2. ReflectiveMethodInvocation 动态代理转入事务拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-TransactionInterceptor-事务拦截器"><span class="toc-number">1.0.3.</span> <span class="toc-text">3. TransactionInterceptor 事务拦截器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-TransactionAspectSupport-事务切面"><span class="toc-number">1.0.4.</span> <span class="toc-text">4. TransactionAspectSupport 事务切面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：determineTransactionManager-返回一个事务管理器"><span class="toc-number">1.0.5.</span> <span class="toc-text">附：determineTransactionManager 返回一个事务管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：asPlatformTransactionManager-强转成为PlatformTransactionManager事务管理器"><span class="toc-number">1.0.6.</span> <span class="toc-text">附：asPlatformTransactionManager 强转成为PlatformTransactionManager事务管理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：createTransactionIfNecessary-创建一个事务"><span class="toc-number">1.0.7.</span> <span class="toc-text">附：createTransactionIfNecessary 创建一个事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：tm-getTransaction-获取一个事务"><span class="toc-number">1.0.8.</span> <span class="toc-text">附：tm.getTransaction 获取一个事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：startTransaction"><span class="toc-number">1.0.9.</span> <span class="toc-text">附：startTransaction</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：DataSourceTransactionManager-doBegin"><span class="toc-number">1.0.10.</span> <span class="toc-text">附：DataSourceTransactionManager.doBegin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：DataSourceTransactionManager-prepareTransactionalConnection"><span class="toc-number">1.0.11.</span> <span class="toc-text">附：DataSourceTransactionManager.prepareTransactionalConnection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#附：TransactionSynchronizationManager-bindResource-将连接绑定在当前线程上"><span class="toc-number">1.0.12.</span> <span class="toc-text">附：TransactionSynchronizationManager.bindResource 将连接绑定在当前线程上</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&text=SpringBoot 事务源码"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&is_video=false&description=SpringBoot 事务源码"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SpringBoot 事务源码&body=Check out this article: http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&title=SpringBoot 事务源码"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2021/06/09/后端开发/SpringBoot 源码/SpringBoot 事务源码/&name=SpringBoot 事务源码&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/archives/">Articles</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/search/">Search</a></li>
        
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
