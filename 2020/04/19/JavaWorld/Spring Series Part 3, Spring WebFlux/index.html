<!DOCTYPE html>
<html lang=en>
<head><meta name="generator" content="Hexo 3.9.0">
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Spring WebFlux introduces reactive web development to the Spring ecosystem. This article will get you started with reactive systems and reactive programming with Spring. First you’ll find out why reac">
<meta name="keywords" content="The Spring Series">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Series Part 3, Spring WebFlux">
<meta property="og:url" content="http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Spring WebFlux introduces reactive web development to the Spring ecosystem. This article will get you started with reactive systems and reactive programming with Spring. First you’ll find out why reac">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://yoursite.com/2020/04/19/JavaWorld/Spring%20Series%20Part%203,%20Spring%20WebFlux/001.jpg">
<meta property="og:image" content="http://yoursite.com/2020/04/19/JavaWorld/Spring%20Series%20Part%203,%20Spring%20WebFlux/002.jpg">
<meta property="og:image" content="http://yoursite.com/2020/04/19/JavaWorld/Spring%20Series%20Part%203,%20Spring%20WebFlux/003.jpg">
<meta property="og:image" content="http://yoursite.com/2020/04/19/JavaWorld/Spring%20Series%20Part%203,%20Spring%20WebFlux/004.jpg">
<meta property="og:updated_time" content="2021-03-16T12:30:24.831Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Series Part 3, Spring WebFlux">
<meta name="twitter:description" content="Spring WebFlux introduces reactive web development to the Spring ecosystem. This article will get you started with reactive systems and reactive programming with Spring. First you’ll find out why reac">
<meta name="twitter:image" content="http://yoursite.com/2020/04/19/JavaWorld/Spring%20Series%20Part%203,%20Spring%20WebFlux/001.jpg">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Spring Series Part 3, Spring WebFlux</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/04/28/数据库/MySQL 指南/MySQL 部署-安装/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/04/19/JavaWorld/Spring Series Part 2, Spring MVC/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&text=Spring Series Part 3, Spring WebFlux"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&is_video=false&description=Spring Series Part 3, Spring WebFlux"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Spring Series Part 3, Spring WebFlux&body=Check out this article: http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&name=Spring Series Part 3, Spring WebFlux&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactive-systems-and-Spring-WebFlux"><span class="toc-number">1.</span> <span class="toc-text">Reactive systems and Spring WebFlux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blocking-vs-non-blocking-web-frameworks"><span class="toc-number">1.1.</span> <span class="toc-text">Blocking vs non-blocking web frameworks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactive-programming"><span class="toc-number">2.</span> <span class="toc-text">Reactive programming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Characteristics-of-a-reactive-system"><span class="toc-number">3.</span> <span class="toc-text">Characteristics of a reactive system</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Reactive-Streams-API"><span class="toc-number">4.</span> <span class="toc-text">The Reactive Streams API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project-Reactor"><span class="toc-number">5.</span> <span class="toc-text">Project Reactor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-started-with-Spring-WebFlux"><span class="toc-number">6.</span> <span class="toc-text">Get started with Spring WebFlux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-1-Maven-pom-xml-for-the-Spring-WebFlux-example-application"><span class="toc-number">6.1.</span> <span class="toc-text">Listing 1. Maven pom.xml for the Spring WebFlux example application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Application-dependencies"><span class="toc-number">6.2.</span> <span class="toc-text">Application dependencies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Spring-Boot-starter-class"><span class="toc-number">7.</span> <span class="toc-text">The Spring Boot starter class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-2-BookserviceApplication"><span class="toc-number">7.1.</span> <span class="toc-text">Listing 2. BookserviceApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Spring-WebFlux-with-annotations"><span class="toc-number">7.2.</span> <span class="toc-text">Using Spring WebFlux with annotations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-application-source-code"><span class="toc-number">8.</span> <span class="toc-text">Example application source code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-3-Book-java"><span class="toc-number">8.1.</span> <span class="toc-text">Listing 3. Book.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-4-BookRepository-java"><span class="toc-number">8.2.</span> <span class="toc-text">Listing 4. BookRepository.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-5-BookService-java"><span class="toc-number">8.3.</span> <span class="toc-text">Listing 5. BookService.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-6-BookServiceImple-java"><span class="toc-number">8.4.</span> <span class="toc-text">Listing 6. BookServiceImple.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-7-BookController-java"><span class="toc-number">8.5.</span> <span class="toc-text">Listing 7. BookController.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#About-the-code"><span class="toc-number">9.</span> <span class="toc-text">About the code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-the-application"><span class="toc-number">10.</span> <span class="toc-text">Run the application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Functional-reactive-services-with-Spring-WebFlux"><span class="toc-number">11.</span> <span class="toc-text">Functional reactive services with Spring WebFlux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Router-and-handler"><span class="toc-number">12.</span> <span class="toc-text">Router and handler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-8-BookHandler-java"><span class="toc-number">12.1.</span> <span class="toc-text">Listing 8. BookHandler.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Important-methods-save-and-flatMap"><span class="toc-number">13.</span> <span class="toc-text">Important methods: save() and flatMap()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-application-code"><span class="toc-number">14.</span> <span class="toc-text">Example application code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-9-BookRouther-java"><span class="toc-number">14.1.</span> <span class="toc-text">Listing 9. BookRouther.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-and-test-the-application"><span class="toc-number">15.</span> <span class="toc-text">Run and test the application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">16.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Spring Series Part 3, Spring WebFlux
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Hexo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-04-19T11:00:03.000Z" itemprop="datePublished">2020-04-19</time>
        
        (Updated: <time datetime="2021-03-16T12:30:24.831Z" itemprop="dateModified">2021-03-16</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/JavaWorld/">JavaWorld</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/The-Spring-Series/">The Spring Series</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Spring WebFlux introduces reactive web development to the Spring ecosystem. This article will get you started with reactive systems and reactive programming with Spring. First you’ll find out why reactive systems are important and how they’re implemented in Spring framework 5, then you’ll get a hands-on introduction to building reactive services using Spring WebFlux. We’ll build our first reactive application using annotations. I’ll also show you how to build a similar application using Spring’s newer functional features.</p>
<h2 id="Reactive-systems-and-Spring-WebFlux"><a href="#Reactive-systems-and-Spring-WebFlux" class="headerlink" title="Reactive systems and Spring WebFlux"></a>Reactive systems and Spring WebFlux</h2><p>The term reactive is currently popular with developers and IT managers, but I’ve noticed some uncertainty about what it actually means. To get clearer on what reactive systems are, it’s helpful to understand the fundamental problem they’re designed to solve. In this section we’ll talk about reactive systems in general, and I’ll introduce the Reactive Systems API for Java applications.</p>
<blockquote>
<p>Scalability in Spring MVC<br>Spring MVC has earned its place among (在…中) the top choices for building Java web applications and web services. Spring MVC seamlessly (无缝地) integrates (使合并) annotations into the robust (强健) architecture of a Spring-based application. This enables developers familiar with Spring to quickly build satisfying, highly functional web applications. Scalability (可扩展性) is a challenge for Spring MVC applications, however. That is the problem Spring WebFlux seeks to address.</p>
</blockquote>
<h3 id="Blocking-vs-non-blocking-web-frameworks"><a href="#Blocking-vs-non-blocking-web-frameworks" class="headerlink" title="Blocking vs non-blocking web frameworks"></a>Blocking vs non-blocking web frameworks</h3><p>In traditional web applications, when a web server receives a request from a client, it accepts that requests and places it in an execution queue. A thread in the execution queue’s thread pool then receives the request, reads its input parameters, and generates a response. Along the way, if the execution thread needs to call a blocking resource — such as a database, a filesystem, or another web service — that thread executes the blocking until the external resource responds, which causes performance issues and limits scalability. To combat these issues, developers create generously sized thread pools, so that while one thread is blocked another thread can continue to process requests. Figure 1 shows the execution flow for a traditional, blocking web application.</p>
<p><img src="001.jpg" alt="Figure 1. Threaded execution model"></p>
<p>Non-blocking web frameworks such as NodeJS and Play take a different approach (方法). Instead of executing a blocking request and waiting for it to complete, the use non-blocking I/O. In this paradigm (范例), an application executes a request, provides code to be executed when a response is returned, and then given its thread back to the server. When an external resource returns a response, the provided code will be executed. Internally (内部的), non-blocking frameworks operate using an event loop. Within the loop, the appliation code either provides a callback or a future containing the code to execute when the asnchronous (异步) loop completes.</p>
<p>By nature, non-blocking frameworks are event-driven. This requires a different programming paradigm and a new approach to reasoning (推理) about how your code will be executed. Once you’ve warpped (变形的) your head arround it, reactive programming can lead to very scalable applications.</p>
<blockquote>
<p>Callbacks, promises, and futures<br>In early days, JavaScript handled all asynchronous functionality via callbacks. In this scenario, when an event occurs (such as when a response from a service call becomes available) the callback is executed. While callbacks are still prevalent, JavaScript’s asynchronous functionality has more recently moved to promises. With promises, a function call returns immediately, returning a promise to deliver the results at a future time. Rather than promises, Java implements a similar paradigm using futures. In this usage, a method returns a future that will have a value at some time in the future.</p>
</blockquote>
<h2 id="Reactive-programming"><a href="#Reactive-programming" class="headerlink" title="Reactive programming"></a>Reactive programming</h2><p>You may have hear the term reactive programming related to web development frameworks and tools, but what does it really mean? The term as we’ve come to know it originated from the Reactive Manifesto, which defines reactive systems as having four core traits (特征):</p>
<ul>
<li>Reactive systems are <strong>responsive</strong>, meaning that they respond in a timely manner (及时的), in all possible circumstances (环境). They focus on providing rapid (瞬间) and consistent response times, establishing (建立) reliable upper bounds (上边界) so they deliver (兑现) a consistent quality of service</li>
<li>Reactive systems are <strong>resilient</strong> (能复原的), meaning that they remain reponsive in the face of failure. Resilience is achieved (实现) by the techniques of relication (同步复制), containment (包容), isolation (隔离性), and delegation (委派). By isolating application compoents from each other, you can contain failures and protect the system as a whole</li>
<li>Reactive systems are elastic (灵活的), meaning that they stay responsive under varying workloads. This is achieved by scaling application components elastically to meet the current demand (需要)</li>
<li>Reactive systems are message-driven, meaning that they rely on asynchronous message passing between components. This allows you to create coupling (耦合), isolation, and location transparency (透明度)</li>
</ul>
<p>Figure 2 shows how these traits (特征) flow together in a reactive system.</p>
<p><img src="002.jpg" alt="Figure 2. Traits of a reactive system"></p>
<h2 id="Characteristics-of-a-reactive-system"><a href="#Characteristics-of-a-reactive-system" class="headerlink" title="Characteristics of a reactive system"></a>Characteristics of a reactive system</h2><p>Reactive systems are built by creating isolated components that communicate with one another asynchronously and can scale quickly to meet the current load. Components still fail in reactive systems, but there are defind actions to perform as a result of the failure, which keeps the system as a whole functional and responsive.</p>
<p>The Reaactive Manifesto is abstract, but reactive applicaitons are typically characcterized by follwoing components or techniques:</p>
<ul>
<li><strong>Data streams</strong>: A stream is a squence of events ordered in time, such as user interactions, REST service calls, JMS messages, and results from a database</li>
<li><strong>Asynchronous</strong>: Data stream events are captured asychronously and your code defines what to do when an event is emiited, when an error occurs, and when the stream of events has completed</li>
<li><strong>Non-blocking</strong>: As you process events, your code should not block and preform synchronouss calls; intead, it should make asychronous calls and respond as the results of those calls are returned</li>
<li><strong>Back pressure</strong>: Components control the number of event and how often they are emitted (发出). In reactive terms, your component is referred to as the subscriber and events are emitted by a pushlier. This is important because the subscriber is in control of how much data it receives and thus will not overburden (超载) itself</li>
<li><strong>Failure message</strong>: Instead of components throwing exceptions, failures are sent as message to a handler function. Whereas throwing exceptions breaks the stream, defining a function to handle failures as the occur does not</li>
</ul>
<h2 id="The-Reactive-Streams-API"><a href="#The-Reactive-Streams-API" class="headerlink" title="The Reactive Streams API"></a>The Reactive Streams API</h2><p>The new Reactive Stream API was created by engineers from Netflix, Pivotal, Lightbeand, RedHat, Twitter, and Oracle, among others. Pushished in 2015, the Reactive Streams API is now part of Java 9. It defines four interfaces:</p>
<ul>
<li><strong>Publisher</strong>: Emits a sequence of events to subscriber</li>
<li><strong>Subscriber</strong>: Recevies and processes events emitted by a Publisher</li>
<li><strong>Subscription</strong>: Defines a one-to-one relationship between a Publisher and a Subscriber</li>
<li><strong>Processor</strong>: Represent a processing stage consisting of both a Subscriber and a Publisher and obeys the contracts of both</li>
</ul>
<p>Figure 3 shows the relationship between a Publisher, and Subscription.</p>
<p><img src="003.jpg" alt="Figure 3. Interfaces in the Reactive Streams API"></p>
<p>In essence (本质), a Subscriber creates a Subscription to a Publisher and, when the Publisher has available data, it sends an event to the Subscriber with a stream of elements. Note that the Subscriber managers its back pressure (挤压) inside its Subscription (订阅) to the Publisher.</p>
<p>Now that you know a litte bit about reactive systems and the Reactive Streams API, let’s turn our attention to the tools Spring uses to implement reactive systems: Spring WebFlux and the Reactor library.</p>
<h2 id="Project-Reactor"><a href="#Project-Reactor" class="headerlink" title="Project Reactor"></a>Project Reactor</h2><p>Project Reactor is a third-party framework based on Java’s Reactive Streams Specification, which is used to build ono-blocking web applications. Project Reactor provides two publishers that are heavily used in Spring WebFlux:</p>
<ul>
<li><strong>Mono</strong>: Returns 0 or 1 element</li>
<li><strong>Flux</strong>: Returns 0 or more elements. A Flux can be endless, meaning that it can keep emitting elements forever, or it can return a sequence of elements and then send a completion notification when it has returned all of its elements</li>
</ul>
<p>Monos and fluxs are conceptually similar to futures, but more powerful. When you invoke a function that returns a mono or a flux, it will return immediately. The results of the function call will be delivered to you through the mono or flux when they become available.</p>
<p>In Spring WebFlux, you will reactive libraries that return monos and fluxes and your controllers will return monos and fluexs. Because these return immediately, your controllers will effectively give up their threads and allow Reactor to handle responses asynchronously. It is improtant to note that only by using reactive libraries can you WebFlux services stay reactive. If you use non-reative libraries, such as JDBC calls, your ocde will block and wait for those calls to complete before returning.</p>
<blockquote>
<p>Reactive programming with MongoDB<br> Currently, there aren’t many reactive database libraries, so you may be wondering if it’s practical to write rective services. The good news is that MongoDB has reactive support and there are a couple of third-party reactive database drivers for MySQL and Postgres. For all other use cases, WebFlux provides a machanism for executing JDBC calls in a reactive manner, albeit using a secondary thread pool that makes blocking JDBC calls.</p>
</blockquote>
<h2 id="Get-started-with-Spring-WebFlux"><a href="#Get-started-with-Spring-WebFlux" class="headerlink" title="Get started with Spring WebFlux"></a>Get started with Spring WebFlux</h2><p>For our first how-to example, we’ll create a simple book service that persists books to and from MongoDB in a reactive fashion.</p>
<p>Start by navigating to the Spring Initializr homepage, where you’ll choose a Maven Project with Java and select the most current release of Spring Boot (2.0.3 at time of this writing). Give your project a group name, such as “com.javaworld.webflux”, and an artifact name, such as “bookservice”. Expand the Switch to the full version like to show the full list of dependencies. Select the following dependencies for the example application:</p>
<ul>
<li>Web -&gt; Reactive Web: The dependency inlucdes Spring WebBlux</li>
<li>NoSQL -&gt; Reactive MongoDB: This dependency inluceds the reactive drivers for MongoDB</li>
<li>NoSQL -&gt; Embedded MongoDB: This dependency allows us to run an embedded version of MongoDB, so there is no need to install a separate instance. Usually this is used for testing, but we’ll include it in our release code to avoid installing MongoDB</li>
<li>Core -&gt; Lombok: Using Lombok is optional as you do not need it to build a Spring WebFlux. The benefit of using Project Lombok is that is enables you to add annotations to classes that will automatically generate getters and setters, constructors, hashCode(), equals(), and more.</li>
</ul>
<p>When you’re finished you should see something similar to Figure 4.</p>
<p><img src="004.jpg" alt="Figure 4. Screenshot of the Spring Initializr project"></p>
<p>Pressing Generate Proejct will trigger the download of a zip file containing your proejct source code. Unzip the download file and open it in your favorite IDE. If you’re using IntelliJ, choose File and then Open, and navigate to the directory where the download zip file has been decompressed.</p>
<p>You’ll find that Spring Initializr has generated two important files:</p>
<ul>
<li>A Maven pom.xml file, includes all necessary dependencies for the application</li>
<li>BookserviceApplicataion.java, which is the Spring Boot starter class for the application</li>
</ul>
<p>Listing 1 shows the contents fo the generated pom.xml file.</p>
<h3 id="Listing-1-Maven-pom-xml-for-the-Spring-WebFlux-example-application"><a href="#Listing-1-Maven-pom-xml-for-the-Spring-WebFlux-example-application" class="headerlink" title="Listing 1. Maven pom.xml for the Spring WebFlux example application"></a>Listing 1. Maven pom.xml for the Spring WebFlux example application</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.javaworld.webflux<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bookservice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>bookservice<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb-reactive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.flapdoodle.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>de.flapdoodle.embed.mongo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Application-dependencies"><a href="#Application-dependencies" class="headerlink" title="Application dependencies"></a>Application dependencies</h3><p>The <code>&lt;parent&gt;</code> node references version 2.0.3.RELEASE of the spring-boot-starter-parent POM file. The parent POM file ensures that all dependency versions are compatible with this version of Spring Boot. These dependencies include:</p>
<ul>
<li>spring-boot-starter-webflux: Packs everything you need to run a WebFlux application, including spring-web (which gives you all of the Spring MVC capabilities) and Netty, which will be our reactive web server, plus a lot more</li>
<li>spring-boot-starter-data-mongodb-reactive: Includes the MongoDB drivers, reactive support for MongoDB, and Spring Data to make writing persistence (坚持) code easier</li>
<li>de.flapdoodle.embed.mongo: Includes an embedded MongoDB instance. By default this dependency will be scoped to “test” so that you can write tests that run against an embedded MongoDB instance and then connect to a standalone MongoDB instance in production. For the purpose of this example I removed the test scoping so that we can run our book service against this embedded MongoDB instance</li>
<li>lombok: Adds annotation niceties for generating getters and setters, constructors, and forth to the application’s model classes</li>
<li>spring-boot-starter-test: Includes Spring testing utilities as well as JUnit and Mockito</li>
<li>reactor-test: Includes testing utilities for testing the Reactor engine, which is used by Spring WebFlux for reactive functionality</li>
</ul>
<h2 id="The-Spring-Boot-starter-class"><a href="#The-Spring-Boot-starter-class" class="headerlink" title="The Spring Boot starter class"></a>The Spring Boot starter class</h2><p>Listing 2 shows the BookserviceApplication.java file.</p>
<h3 id="Listing-2-BookserviceApplication"><a href="#Listing-2-BookserviceApplication" class="headerlink" title="Listing 2. BookserviceApplication"></a>Listing 2. BookserviceApplication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookserviceApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(BookserviceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The BookserviceApplication is annotated with the <strong>@SpringBootApplication</strong> annotation. <strong>@SpringBootApplication</strong> is a convenience (方便) annotation that encompasses (包含) the following annotations:</p>
<ul>
<li><strong>@EnableAutoConfiguration</strong> enables auto-configuration of the Spring application context, attemping to guess and configure beans that you are likely to need. Auto-configuration classes are usually applied based on your CLASSPATH and the beans you have defined. For example, when you include the embedded MongoDB dependency in your CLASSPATH, Spring will automatically create an instance in memory and wire it into the application context</li>
<li><strong>@SpringBootConfiguration</strong> identifies this class as containing the Spring Boot configuration</li>
<li><strong>@ComponentScan</strong> directs Spring to scan the CLASSPATH, in the current package and all sub-packages, for Spring components. In short, this allows you to create a web package and add a <strong>@Controller</strong>, which Spring will find and make available to the application</li>
</ul>
<p>The BookserviceApplication itself defines a main() method that delegates to the SpringApplication.run() method, which starts the application.</p>
<h3 id="Using-Spring-WebFlux-with-annotations"><a href="#Using-Spring-WebFlux-with-annotations" class="headerlink" title="Using Spring WebFlux with annotations"></a>Using Spring WebFlux with annotations</h3><p>In order to build our book service we need to define the following classes and interfaces:</p>
<ul>
<li><strong>Book</strong>: A model class representing a book in our service</li>
<li><strong>BookRepository</strong>: A Spring Data MongoDB interface telling Spring Data to generate persistence code for books to and from MongoDB</li>
<li><strong>BookService</strong> and <strong>BookServiceImpl</strong>: The “business” service used to interact with the BookRepository to persist book to and from MongoDB. In this example, a service is not necessary and we could place calls to the BookRepository directly in our controller. When building Spring applications it is recommended to create this layer as a business interface between your controllers and persistence repository, however. The business interface enables you to change your repository — such as moving to an SQL-based database or calling another web service — without impacting your controllers.</li>
<li><strong>BookController</strong>: The web controller that will receive web requests and return reactive reponse (Monos and Fluxs)</li>
</ul>
<h2 id="Example-application-source-code"><a href="#Example-application-source-code" class="headerlink" title="Example application source code"></a>Example application source code</h2><p>Listing 3 shows the source code for our model class, Book.java</p>
<h3 id="Listing-3-Book-java"><a href="#Listing-3-Book-java" class="headerlink" title="Listing 3. Book.java"></a>Listing 3. Book.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The Book class is a simple POJO that contains an ID, title, and author. It is annotated with the <strong>@Document</strong> annotation, which identifies it as a MongoDB document. Spring Data will map documents to collections in MongoDB. THe next three annotations — <strong>@Data</strong>, <strong>@NoArgsContructor</strong>, and <strong>@AllArgsConstructor</strong> — are Lombok annotations. <strong>@Data</strong> includes the following capabilities:</p>
<ul>
<li>Generates getters and setters for all fields; setters are only generated for non-final properties</li>
<li>Generates a required arguments constructor</li>
<li>Generates a <strong>ToString()</strong> method</li>
<li>Generates <strong>equals()</strong> and <strong>hashCode()</strong> methods that uses all non-transient (非暂态) fields</li>
</ul>
<p>In order to work with Spring Data, we need a no-argument constructor so I added <strong>@NoArgsContructor</strong>. For testing purposes I also added an all-argument constructor, <strong>@AllArgsConstructor</strong>.</p>
<p>As mentioned above, Lombok is not required and you can simply implement getters, setters, and constructors to the class as you normally would do.</p>
<p>Listing 4 shows the source code for the BookRepository interafce.</p>
<h3 id="Listing-4-BookRepository-java"><a href="#Listing-4-BookRepository-java" class="headerlink" title="Listing 4. BookRepository.java"></a>Listing 4. BookRepository.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">ReactiveMongoRepository</span>&lt;<span class="title">Book</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The BookRepsiotry is a Spring Data interface, meaning that you define the interface and Spring Data weill generate the code that implements that interface. Specifically, BookRepository extends teh ReactiveMongoRepository, which defines the following reactive methods (remember that these are methods that return either monos or fluxs):</p>
<ul>
<li><code>Mono&lt;Book&gt; save()</code></li>
<li><code>Flux&lt;Book&gt; saveAll()</code></li>
<li><code>Flux&lt;Book&gt; findById()</code></li>
<li><code>Mono&lt;Boolean&gt; existsById()</code></li>
<li><code>Flux&lt;Book&gt; findAll()</code></li>
<li><code>Flux&lt;Book&gt; findAllById()</code></li>
<li><code>Mono&lt;Long&gt; count()</code></li>
<li><code>Mono&lt;Void&gt; delete()</code></li>
<li><code>Mono&lt;Void&gt; deleteById()</code></li>
<li><code>Mono&lt;Voidd&gt; delteAll()</code></li>
<li><code>Flux&lt;Book&gt; insert()</code></li>
</ul>
<p>The query methods that return one element (such as <code>findById()</code>) return <code>Mono&lt;Book&gt;</code>. The methods that return more than one elements (such as <code>findAll()</code>) return <code>Flux&lt;Book&gt;</code>. It is interesting to note that the <code>delete</code> methods return a <code>Mono&lt;Void&gt;</code>. <code>Mono&lt;Void&gt;</code> means that there is no return type, but when the operation finishes it will publish a completion notification. Recall that these are publishers, so your code, or Spring WebFlux itself, will ultimately define functionality to execute when a message is published to its subscribers.</p>
<p>The BookRepository is defined with two generic parameters: Book, which is the type of document that the repository managers, and String, which is the type of the primary key (the Book’s id field). Your code can use the BookRepository methods to execute asynonchroous queries against MongoDB.</p>
<p>Listing 5 and 6 show the source code for the BookService and BookServiceImpl, respectively.</p>
<h3 id="Listing-5-BookService-java"><a href="#Listing-5-BookService-java" class="headerlink" title="Listing 5. BookService.java"></a>Listing 5. BookService.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Mono&lt;Book&gt; <span class="title">findById</span><span class="params">(String id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Flux&lt;Book&gt; <span class="title">findAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Mono&lt;Book&gt; <span class="title">save</span><span class="params">(Book book)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Mono&lt;Void&gt; <span class="title">deleteById</span><span class="params">(String id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Listing-6-BookServiceImple-java"><a href="#Listing-6-BookServiceImple-java" class="headerlink" title="Listing 6. BookServiceImple.java"></a>Listing 6. BookServiceImple.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookServiceImpl</span> <span class="keyword">implements</span> <span class="title">BookService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BookRepository bookRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookServiceImpl</span><span class="params">(BookRepository bookRepsotiry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookRepository = bookRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Book&gt; <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Book&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Book&gt; <span class="title">save</span><span class="params">(Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookRepository.save(book);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">deleteById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Services represent business functionality and are identified in Spring using the <code>@Service</code> annotation. In this example, business functionality simply delegates to the underlying (隐含的) repository. If you needed to perform more complex logic on the queries or on the objects being persisted, this is where you would do it.</p>
<p>Listing 7 shows the source code for the BookController class.</p>
<h3 id="Listing-7-BookController-java"><a href="#Listing-7-BookController-java" class="headerlink" title="Listing 7. BookController.java"></a>Listing 7. BookController.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BookService bookService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookController</span><span class="params">(BookService bookService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookService = bookService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/book/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Book&gt; <span class="title">getBookById</span><span class="params">(@PathVariable String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/books"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;Book&gt; <span class="title">getAllBooks</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/book"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Book&gt; <span class="title">createBook</span><span class="params">(@RequestBody Book book)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bookService.save(book);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="About-the-code"><a href="#About-the-code" class="headerlink" title="About the code"></a>About the code</h2><p>If you’re already familiar with Spring MVC, you’ll notice that the Spring WebFlux application code looks remarkably familiar. The only difference is that all controllers and services return reactive types, namely monos and fluxes. We’ve also employed a reactive MongoDB driver instead of a nonreactive driver. While the code is familiar, the implementation is quite different. Under the hood, Spring WebFlux will invoke your handler method, capture the reactive reponse, and then leverage Reactor to wait for the response to be published, all asynchronously.</p>
<p>Here are some points to note about the example application:</p>
<ul>
<li><code>BookController</code> is annotated with the <code>@RestController</code> annotation, which is a convenience annotation. This annotation includes the <code>@Controller</code> annotation, which is used to identify a class that handles web request, and <code>@ResponseBody</code>, which indicates that method return values should be bound to the web response body</li>
<li><code>getBookById()</code> method, which is annotated with the <code>@GetMapping</code> annotation. <code>@GetMapping</code> is a convenience annotation for <code>@RequestMapping(method = RequestMethod.GET)</code>. It handles the URI path: <code>/book/{id}</code>, where the id is the value retrieved from the path and passed as the <code>@PathVariable</code> in the method call. The implementation simply delegates to the BookService’s <code>findById()</code> method. Note that this method returns a <code>Mono&lt;Book&gt;</code>, which again is a publisher that will provide WebFlux with a Book instance when it becomes available, ultimately from the reactive MongoDB call to <code>findById()</code>.</li>
<li><code>getAllBooks()</code> method handles the <code>/books</code> URI path and delegates to the BookService’s <code>findALl()</code> method. In this case it returns a <code>Flux&lt;Book&gt;</code>, which is a pulisher that send a stream of Books to Spring WebFlux. When all books have been retrieved from MongoDB, the reactive MongoDB <code>findAll()</code> method will publish a completion notification telling WebFlux that it is finished. WebFlux can then send the response back to the caller</li>
<li>Finally, the <code>createBook()</code> method is annotated with the <code>@PostMapping</code> annotation, which is a convenience annotation for <code>@RequestMapping(method = RequestMethod.POST)</code>. <code>@PostMapping</code> handles the <code>/book</code> URI path. The <code>@RequestBody</code> annotation, included when we added <code>@RestController</code> tells WebFlux to convert the object received from the caller into a Book instance. The <code>createBook()</code> method delegates to the BookService’s <code>save()</code> method and then returns a <code>Mono&lt;Book&gt;</code> that publishes the newly created Book.</li>
</ul>
<blockquote>
<p>Three styles of denpendency injection<br>The BookController uses contructor injetcion to autowire a BookService into itself. Recall that Spring supports three types of denpendency injection:</p>
<ul>
<li>Constructor injection: when a Spring-managed bean defines a constructor that accepts another Spring-managed bean, Spring will automatically retrieve an instance of that bean from the application context and pass it to the constructor</li>
<li>Setter injection: when a Spring-managed bean defines a setter method that accepts another Spring-managed bean, Spring will likewise find it in the application context and invoke the setter method</li>
<li>@Autowired: when a Spring-managed bean defines a field annotated with the @Autowired annotation, Spring will automatically set the value of the filed</li>
</ul>
</blockquote>
<h2 id="Run-the-application"><a href="#Run-the-application" class="headerlink" title="Run the application"></a>Run the application</h2><p>You can run your new service by exeucting the following command from the root directory of your project:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure></p>
<p>Now take out your favorite REST service testing tool, like Poster, or execute the following cURL commands on your command-line. See the responses below each cURL command:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ curl --header <span class="string">"Content-Type: application/json"</span> --request POST --data <span class="string">'&#123;"title": "Book 1", "author": "Mr Author"&#125;'</span> http://localhost:8080/book</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b2ea197c0f951f7354085d7"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Mr Author"</span>&#125;</span><br><span class="line">$ curl --header <span class="string">"Content-Type: application/json"</span> --request POST --data <span class="string">'&#123;"title": "Book 2", "author": "Other Author"&#125;'</span> http://localhost:8080/book</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b2ea1b0c0f951f7354085d8"</span>,<span class="string">"title"</span>:<span class="string">"Book 2"</span>,<span class="string">"author"</span>:<span class="string">"Other Author"</span>&#125;</span><br><span class="line">$ curl http://localhost:8080/books</span><br><span class="line">[&#123;<span class="string">"id"</span>:<span class="string">"5b2ea197c0f951f7354085d7"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Mr Author"</span>&#125;,&#123;<span class="string">"id"</span>:<span class="string">"5b2ea1b0c0f951f7354085d8"</span>,<span class="string">"title"</span>:<span class="string">"Book 2"</span>,<span class="string">"author"</span>:<span class="string">"Other Author"</span>&#125;]</span><br><span class="line">$ curl http://localhost:8080/book/5b2ea197c0f951f7354085d7</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b2ea197c0f951f7354085d7"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Mr Author"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Functional-reactive-services-with-Spring-WebFlux"><a href="#Functional-reactive-services-with-Spring-WebFlux" class="headerlink" title="Functional reactive services with Spring WebFlux"></a>Functional reactive services with Spring WebFlux</h2><p>Spring WebFlux application can be built using either Spring MVC annotations (which you just saw) or functional programming techniques. Functional programming has many benefits, such as immutable data objects, inherent thread safety, the ability to pass functions to other functions, and the ability to program declaratively rather than imperatively (meaning that you describe the problem you are solving, not hte steps that define how to solve the problem).</p>
<p>Pure functions — or functions that provide the same result every time they are given the same input — limit side-effects, which makes testing easier. They also allows for easy parallelization and caching. If you haven’t taken the time to start learning functional programming, I encourage you to do so; It will change how you approach and solve problems.</p>
<p>Arjen Poutsma, a mamber of the Spring WebFlux team, posted a vieo on YouTube entitled “New in Spring Framework 5.0: Functional Web framework” that describes the motivation behind building functional web applications and how Spring WebFlux can be used functionally. In short, he argues for more library, less framework, meaning that WebFlux can be used as a library that leaves you in control of your web application. This is an efficient alternative to utilizing the full Spring framework, which is the approach we took in the previous section.</p>
<p>We’ll conclude this tutorial by using Spring WebFlux to build another BookHandler application, this time using functional techniques.</p>
<h2 id="Router-and-handler"><a href="#Router-and-handler" class="headerlink" title="Router and handler"></a>Router and handler</h2><p>Our functional Spring WebFlux application will be based on two main components, a router and a handler. The router is responsible ofr routing HTTP requests to handler functions. Handler functions are responsible for executing business functionality and building responses.</p>
<p>Listing 8 shows the source code for the BookHandler class.</p>
<h3 id="Listing-8-BookHandler-java"><a href="#Listing-8-BookHandler-java" class="headerlink" title="Listing 8. BookHandler.java"></a>Listing 8. BookHandler.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BookService bookService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookHandler</span><span class="params">(BookService bookService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bookService = bookService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">findById</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        String id = request.pathVariable(<span class="string">"id"</span>);</span><br><span class="line">        <span class="keyword">return</span> ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(bookService.findById(id), Book.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">findAll</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(bookService.findAll(), Book.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">save</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Mono&lt;Book&gt; book = request.bodyToMono(Book.class);</span><br><span class="line">        <span class="keyword">return</span> ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(fromPublisher(book.flatMap(bookService::save), Book.class));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">delete</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        String id = request.pathVariable(<span class="string">"id"</span>);</span><br><span class="line">        <span class="keyword">return</span> ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .body(bookService.deleteById(id), Void.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The BookHandler is annotated with <code>@Component</code>, a generic annotation that identifies the class as being a Spring-managed bean. Spring will discover this component when it does its component scan and add it to the application context. This is not a controller, but rather a standard Spring bean that will be wired into the BookRouter, defined below.</p>
<p>The functions in the BookHandler return <code>Mono&lt;ServerResponse&gt;</code>. This component is a litte different from the BookController built in the previous section, which returned <code>Mono&lt;Book&gt;</code> and <code>Flux&lt;Book&gt;</code>. When building a handler function, you are responsible for building the response that will ultimately be returned to the caller. All methods are requried to return a <code>Mon&lt;ServerResponse&gt;</code>, even if the body of the response contains a Flux.</p>
<p>Each method is passed a ServerRequest argument, which provides access to request parameters, such as path variables, query parameters, and, in the case of the <code>save()</code> method, the body of a POST or PUT.</p>
<p>In order to build a response body, we construct it using a BodyBuilder. The <code>ok()</code> method returns a BodyBuilder with an HTTP status code of 200; it is a convenience method for <code>status(HttpStatus.OK)</code>. The BodyBuilder interface defines methods for setting the content type, content length, as well as HTTP header values. The <code>body()</code> method sets the contents to be returned to the caller and returns a <code>Mono&lt;ServerResponse&gt;</code>.</p>
<h2 id="Important-methods-save-and-flatMap"><a href="#Important-methods-save-and-flatMap" class="headerlink" title="Important methods: save() and flatMap()"></a>Important methods: save() and flatMap()</h2><p>The method in this class that deservers special attention is the <code>save()</code> method. First, in order to deserialize the body payload to a class instance, we invoke the <code>bodyToMono()</code> method. This mehtod returns a <code>Mono&lt;Book&gt;</code>, which is a publisher that will provide a Book instance asynchronously when it is available. With the <code>Mono&lt;Book&gt;</code> in hand, we construct the response using the <code>ok()</code> method, as usual, and then the <code>body()</code> method is implemented as folows:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fromPublisher(book.flatMap(bookService::save), Book.class)</span><br></pre></td></tr></table></figure></p>
<p>The <code>fromPbulisher()</code> method reutrns a BodyInserter, which the <code>body()</code> method expects, from a publisher function and the class of the object that will be published, Book.class in this case. The publisher function is passed the following:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">book.flatMap(bookService::save)</span><br></pre></td></tr></table></figure></p>
<p>You’re probably already familiar with the Java 8 <code>map()</code> funciton, which converts every input item in a stream (or in the Mono in this case) into another object. The Java 8 <code>flatMap()</code> function is similar, but it “flattens” the response. For example, if we were constructing a list of objects and the map function returned am embedded list, rather than a list of lists, the <code>flatMap()</code> funciton would return a single list that contained all of the elements in all embedded lists.</p>
<p>We can read this function as follow: for each Book in the book object, which is a Mono so there will only be one, call the BookService’s <code>save()</code> method, and return the result of <code>BookService::save</code> to the caller (<code>fromPublisher()</code> in this case) as a single Mono object (not a <code>Mono&lt;Mono&lt;Book&gt;&gt;</code>). The <code>faltMap()</code> function takes care of flattening embedded Monos into a single Mono.</p>
<h2 id="Example-application-code"><a href="#Example-application-code" class="headerlink" title="Example application code"></a>Example application code</h2><p>Listing 9 show the source code for the BookRouter class.</p>
<h3 id="Listing-9-BookRouther-java"><a href="#Listing-9-BookRouther-java" class="headerlink" title="Listing 9. BookRouther.java"></a>Listing 9. BookRouther.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookRouter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">route</span><span class="params">(BookHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">                .route(GET(<span class="string">"/fbooks"</span>).and(accept(MediaType.APPLICATION_JSON)), handler::findAll)</span><br><span class="line">                .andRoute(GET(<span class="string">"/fbook/&#123;id&#125;"</span>).and(accept(MediaType.APPLICATION_STREAM_JSON)), handler::findById)</span><br><span class="line">                .andRoute(POST(<span class="string">"/fbook"</span>).and(accept(MediaType.APPLICATION_JSON)), handler::save)</span><br><span class="line">                .andRoute(DELETE(<span class="string">"/fbook/&#123;id&#125;"</span>).and(accept(MediaType.APPLICATION_JSON)), handler::delete);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The BookRouter class is annotated with <code>@Configuration</code>, which is a Spring annotation that identifies a class as a configuration class whose method create other Spring beans. In this example, the <code>router()</code> method creates a bean of type <code>RouterFunciton&lt;ServerResponse&gt;</code>. Router functions are responsible for translting HTTP routes (HTTP verb and URI path) into handler functions. For example, the first route reads: if there is a request of type GET for the URI path <code>/fbooks</code> and a media accept type of APOLICATION_JSON, then invoke the BookHandler’s <code>findAll()</code> method.</p>
<p>The syntax might look a little strange, so let’s take it apart. First, consider the <code>GET()</code> method:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET(<span class="string">"/fbooks"</span>).and(accept(MediaType.APPLICATION_JSON)), handler::findAll</span><br></pre></td></tr></table></figure></p>
<p>The <code>GET()</code> method is statically imported from the RequestPredicates class and reutrns a RequestPredicate instance. A predicate is a boolean-valued function with a <code>test()</code> method that evaluates the predicate and returns true or false if the predicate’s conditions are met. A RequestPredicate evaluates a ServerRequest to determine whether or not this route should handle the request. So our goal is to define the criteria under which our handler function should be called.</p>
<p><code>GET()</code> is a convenience method for </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method(HttpMethod.GET).and(path(String Pattern))</span><br></pre></td></tr></table></figure>
<p>This means that the RequestPredicate will compare the HTTP verb in the ServerRequest to HttpMehod.GET and the path to the specified URI pattern. We then chain <code>accept(MediaType.APPICATION_JSON)</code> to the predicate using the <code>and()</code> method, which is a standard Predicate funciton that evaluates two prediates using AND boolean logic. The <code>accept()</code> method adds a condition to the predicate that verifies the “Accept” HTTP header against the provided media type. In the end, the <code>handler::findAll</code> method will be invoked if the following conditions are true:</p>
<ul>
<li>The HTTP verb is GET</li>
<li>THe URI path is <code>/fbooks</code></li>
<li>The HTTP “ACCEPT” header is “applicaiton/json”</li>
</ul>
<p>The <code>RoutherFunction::route</code> method returns a RouterFunction that allows you to add additional routes by invoking the <code>addRoute()</code> method. As you can see, we leverage this capability to chain together several different routes: GET with an id request parameter, POST and DELETE.</p>
<p>The only other magic in the BookRouter::route method is the Spring injection of the BookHandler. The router() method is annotated with <code>@Bean</code>, which means that it returns a Spring-managed bean. When Spring invokes this method it will see that requires a BookHandler argument. Having already discovered the BookHandler (annotated with <code>@Component</code>), and having added it to the application context, it will pass the Spring-managed BookHandler to the <code>route()</code> method.</p>
<p>In summary, the <code>BookRouter::route</code> create a RouterFunction, which is composed of several router functions that define the conditions for which specific handler functions should be invoked.</p>
<h2 id="Run-and-test-the-application"><a href="#Run-and-test-the-application" class="headerlink" title="Run and test the application"></a>Run and test the application</h2><p>You can test this code by starting the Spring Boot application with the following command:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure></p>
<p>Now you have two sets of end-points: <code>/book</code> uses the BookController and <code>/fbook</code> uses the functional BookRouter and BookHandler. The following are sample cURL commands to invoke these services:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ curl --header <span class="string">"Content-Type: application/json"</span> --request POST --data <span class="string">'&#123;"title": "Book 1", "author": "Author"&#125;'</span> http://localhost:8080/fbook</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b394748aaac8a7c67f94367"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;</span><br><span class="line">$ curl --header <span class="string">"Content-Type: application/json"</span> --request POST --data <span class="string">'&#123;"title": "Book 2", "author": "Author"&#125;'</span> http://localhost:8080/fbook</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b39474daaac8a7c67f94368"</span>,<span class="string">"title"</span>:<span class="string">"Book 2"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;</span><br><span class="line">$ curl http://localhost:8080/fbooks</span><br><span class="line">[&#123;<span class="string">"id"</span>:<span class="string">"5b394748aaac8a7c67f94367"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;,</span><br><span class="line"> &#123;<span class="string">"id"</span>:<span class="string">"5b39474daaac8a7c67f94368"</span>,<span class="string">"title"</span>:<span class="string">"Book 2"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;]</span><br><span class="line">$ curl http://localhost:8080/fbook/5b39474daaac8a7c67f94368</span><br><span class="line">&#123;<span class="string">"id"</span>:<span class="string">"5b39474daaac8a7c67f94368"</span>,<span class="string">"title"</span>:<span class="string">"Book 2"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;</span><br><span class="line">$ curl --header <span class="string">"Content-Type: application/json"</span> --request DELETE http://localhost:8080/fbook/5b39474daaac8a7c67f94368</span><br><span class="line">$ curl http://localhost:8080/fbooks</span><br><span class="line">[&#123;<span class="string">"id"</span>:<span class="string">"5b394748aaac8a7c67f94367"</span>,<span class="string">"title"</span>:<span class="string">"Book 1"</span>,<span class="string">"author"</span>:<span class="string">"Author"</span>&#125;]</span><br></pre></td></tr></table></figure></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Spring WebFlux is Spring’s reactive web framework that uses the Reactor library to asynchronously manage web requests. I start this article by reviewing reactive systems and the Reactive Streaming API, and described the problems they’re designed to solve. I then showd you two ways to create a Spring WebFlux application: the tradition-based approach and the fuctnional approach. Spring WebFlux was introduced in Spring framework 5, and is new to the Spring ecosystem. It will undoubtedly continue to evolve. Still, it is already a powerful framework and library very scalable reactive web applications.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Categories</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactive-systems-and-Spring-WebFlux"><span class="toc-number">1.</span> <span class="toc-text">Reactive systems and Spring WebFlux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Blocking-vs-non-blocking-web-frameworks"><span class="toc-number">1.1.</span> <span class="toc-text">Blocking vs non-blocking web frameworks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactive-programming"><span class="toc-number">2.</span> <span class="toc-text">Reactive programming</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Characteristics-of-a-reactive-system"><span class="toc-number">3.</span> <span class="toc-text">Characteristics of a reactive system</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Reactive-Streams-API"><span class="toc-number">4.</span> <span class="toc-text">The Reactive Streams API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Project-Reactor"><span class="toc-number">5.</span> <span class="toc-text">Project Reactor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Get-started-with-Spring-WebFlux"><span class="toc-number">6.</span> <span class="toc-text">Get started with Spring WebFlux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-1-Maven-pom-xml-for-the-Spring-WebFlux-example-application"><span class="toc-number">6.1.</span> <span class="toc-text">Listing 1. Maven pom.xml for the Spring WebFlux example application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Application-dependencies"><span class="toc-number">6.2.</span> <span class="toc-text">Application dependencies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Spring-Boot-starter-class"><span class="toc-number">7.</span> <span class="toc-text">The Spring Boot starter class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-2-BookserviceApplication"><span class="toc-number">7.1.</span> <span class="toc-text">Listing 2. BookserviceApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-Spring-WebFlux-with-annotations"><span class="toc-number">7.2.</span> <span class="toc-text">Using Spring WebFlux with annotations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-application-source-code"><span class="toc-number">8.</span> <span class="toc-text">Example application source code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-3-Book-java"><span class="toc-number">8.1.</span> <span class="toc-text">Listing 3. Book.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-4-BookRepository-java"><span class="toc-number">8.2.</span> <span class="toc-text">Listing 4. BookRepository.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-5-BookService-java"><span class="toc-number">8.3.</span> <span class="toc-text">Listing 5. BookService.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-6-BookServiceImple-java"><span class="toc-number">8.4.</span> <span class="toc-text">Listing 6. BookServiceImple.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-7-BookController-java"><span class="toc-number">8.5.</span> <span class="toc-text">Listing 7. BookController.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#About-the-code"><span class="toc-number">9.</span> <span class="toc-text">About the code</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-the-application"><span class="toc-number">10.</span> <span class="toc-text">Run the application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Functional-reactive-services-with-Spring-WebFlux"><span class="toc-number">11.</span> <span class="toc-text">Functional reactive services with Spring WebFlux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Router-and-handler"><span class="toc-number">12.</span> <span class="toc-text">Router and handler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-8-BookHandler-java"><span class="toc-number">12.1.</span> <span class="toc-text">Listing 8. BookHandler.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Important-methods-save-and-flatMap"><span class="toc-number">13.</span> <span class="toc-text">Important methods: save() and flatMap()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Example-application-code"><span class="toc-number">14.</span> <span class="toc-text">Example application code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Listing-9-BookRouther-java"><span class="toc-number">14.1.</span> <span class="toc-text">Listing 9. BookRouther.java</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-and-test-the-application"><span class="toc-number">15.</span> <span class="toc-text">Run and test the application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">16.</span> <span class="toc-text">Conclusion</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&text=Spring Series Part 3, Spring WebFlux"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&is_video=false&description=Spring Series Part 3, Spring WebFlux"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Spring Series Part 3, Spring WebFlux&body=Check out this article: http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&title=Spring Series Part 3, Spring WebFlux"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/04/19/JavaWorld/Spring Series Part 3, Spring WebFlux/&name=Spring Series Part 3, Spring WebFlux&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 John Doe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/archives/">Articles</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/search/">Search</a></li>
        
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
